"use strict";var it=Object.create;var H=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var ct=Object.getOwnPropertyNames;var mt=Object.getPrototypeOf,dt=Object.prototype.hasOwnProperty;var pt=(t,e)=>{for(var r in e)H(t,r,{get:e[r],enumerable:!0})},Ie=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of ct(e))!dt.call(t,a)&&a!==r&&H(t,a,{get:()=>e[a],enumerable:!(o=lt(e,a))||o.enumerable});return t};var p=(t,e,r)=>(r=t!=null?it(mt(t)):{},Ie(e||!t||!t.__esModule?H(r,"default",{value:t,enumerable:!0}):r,t)),ft=t=>Ie(H({},"__esModule",{value:!0}),t);var rr={};pt(rr,{activate:()=>er,deactivate:()=>tr});module.exports=ft(rr);var x=p(require("vscode"));var L=p(require("fs")),Ce=require("child_process"),X=null;function ut(){switch(process.platform){case"darwin":return"macos";case"win32":return"windows";default:return"linux"}}function gt(){try{return L.readFileSync("/proc/version","utf-8")}catch{return null}}function Te(t){return t?/microsoft/i.test(t):!1}function ht(t){return!t||!Te(t)?null:/microsoft-standard-WSL2/i.test(t)?2:1}function wt(){return L.existsSync("/mnt/wslg/")}function vt(t,e){if(t!=="linux")return"unknown";if(e)return process.env.WAYLAND_DISPLAY?"wayland":process.env.DISPLAY?"x11":"unknown";let r=process.env.XDG_SESSION_TYPE;return r==="wayland"?"wayland":r==="x11"?"x11":process.env.WAYLAND_DISPLAY?"wayland":"unknown"}function Fe(t){try{return(0,Ce.execFileSync)("command",["-v",t],{encoding:"utf-8",timeout:5e3,shell:!0}).trim()||null}catch{return null}}function bt(t,e){if(t==="windows")return"powershell.exe";if(e){let r=["/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe","/mnt/c/Program Files/PowerShell/7/pwsh.exe"];for(let a of r)if(L.existsSync(a))return a;let o=Fe("powershell.exe")??Fe("pwsh.exe");return o||"powershell.exe"}return null}function J(){if(X)return X;let t=ut(),e=t==="linux"?gt():null,r=t==="linux"?Te(e):!1,o=r?ht(e):null,a=r?wt():!1,s=vt(t,r),n=bt(t,r);return X={os:t,isWSL:r,wslVersion:o,hasWslg:a,displayServer:s,powershellPath:n},X}var Ee=p(require("vscode"));function Z(){let t=Ee.env.remoteName;return t?{remote:!0,type:t}:{remote:!1}}var O=require("child_process"),fe=1e4,Pt=10*1024*1024,$e=50*1024*1024;function ue(t){return"code"in t&&typeof t.code=="number"?t.code:t.code??"unknown"}function d(t,e,r){return new Promise((o,a)=>{(0,O.execFile)(t,e,{encoding:"utf-8",timeout:r?.timeout??fe,maxBuffer:r?.maxBuffer??Pt,cwd:r?.cwd},(s,n,i)=>{if(s){a(new Error(`Command "${t}" failed (exit code ${ue(s)}): ${i||s.message}`));return}o({stdout:n,stderr:i})})})}function P(t,e,r){return r?.input?yt(t,e,r):new Promise((o,a)=>{(0,O.execFile)(t,e,{encoding:"buffer",timeout:r?.timeout??fe,maxBuffer:r?.maxBuffer??$e,cwd:r?.cwd},(s,n,i)=>{let m=i instanceof Buffer?i.toString("utf-8"):String(i);if(s){a(new Error(`Command "${t}" failed (exit code ${ue(s)}): ${m||s.message}`));return}o({stdout:n,stderr:m})})})}function yt(t,e,r){let o=r.timeout??fe,a=r.maxBuffer??$e;return new Promise((s,n)=>{let i=(0,O.spawn)(t,e,{stdio:["pipe","pipe","pipe"],cwd:r.cwd}),m=[],c=[],f=0,w=0,b=!1,T=setTimeout(()=>{b||(b=!0,i.kill("SIGTERM"),n(new Error(`Command "${t}" failed (exit code ETIMEDOUT): timed out after ${o}ms`)))},o);i.stdout.on("data",u=>{if(f+=u.length,f>a){b||(b=!0,clearTimeout(T),i.kill("SIGTERM"),n(new Error(`Command "${t}" failed (exit code ERR_CHILD_PROCESS_STDIO_MAXBUFFER): stdout maxBuffer length exceeded`)));return}m.push(u)}),i.stderr.on("data",u=>{w+=u.length,w<=a&&c.push(u)}),i.on("error",u=>{b||(b=!0,clearTimeout(T),n(new Error(`Command "${t}" failed (exit code ${ue(u)}): ${u.message}`)))}),i.on("close",u=>{if(b)return;b=!0,clearTimeout(T);let S=Buffer.concat(c).toString("utf-8");if(u!==0){n(new Error(`Command "${t}" failed (exit code ${u??"unknown"}): ${S||`process exited with code ${u}`}`));return}s({stdout:Buffer.concat(m),stderr:S})}),i.stdin.on("error",()=>{}),i.stdin.end(r.input)})}var Ae=require("child_process");var Re=p(require("vscode"));function ge(){let t=new Date,e=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0"),a=String(t.getMilliseconds()).padStart(3,"0");return`[${e}:${r}:${o}.${a}]`}function xt(t){let e=Re.window.createOutputChannel(t);return{info(r){e.appendLine(`${ge()} [INFO] ${r}`)},warn(r,o){let a=`${ge()} [WARN] ${r}`;o!==void 0&&(o instanceof Error&&o.stack?a+=`
${o.stack}`:a+=`
${String(o)}`),e.appendLine(a)},error(r,o){let a=`${ge()} [ERROR] ${r}`;o!==void 0&&(o instanceof Error&&o.stack?a+=`
${o.stack}`:a+=`
${String(o)}`),e.appendLine(a)},show(){e.show()}}}var l=xt("Terminal Image Paste");var ke=new Map,St=process.platform==="win32";async function It(t){let e=ke.get(t);if(e!==void 0)return e;let r=St?"where":"which";try{let o=await new Promise((a,s)=>{(0,Ae.execFile)(r,[t],{timeout:5e3},(n,i)=>{if(n){s(n);return}let m=i.trim().split(/\r?\n/)[0];a(m)})});return ke.set(t,o),o}catch{l.warn(`Could not resolve absolute path for "${t}" \u2014 using bare name`);return}}async function A(t){return await It(t)??t}async function j(){let{stdout:t}=await d("osascript",["-e","clipboard info"]);return t}function U(t){let e=[];return t.includes("\xABclass PNGf\xBB")&&e.push("png"),(t.includes("\xABclass JPEG\xBB")||t.includes("\xABclass JPEf\xBB"))&&e.push("jpeg"),t.includes("\xABclass TIFF\xBB")&&e.push("tiff"),(t.includes("\xABclass BMP \xBB")||t.includes("\xABclass BMPf\xBB"))&&e.push("bmp"),e}var Q=class{resolvedPngpastePath;async getPngpastePath(){return this.resolvedPngpastePath===void 0&&(this.resolvedPngpastePath=await A("pngpaste")),this.resolvedPngpastePath}requiredTool(){return"pngpaste"}async isToolAvailable(){try{return await d("which",["pngpaste"]),!0}catch{return!1}}async hasImage(){try{let e=await j();return U(e).length>0}catch{return!1}}async detectFormat(){let e=await j(),r=U(e);if(r.length>0)return r[0];throw new Error("No image found in clipboard")}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let r=await this.getPngpastePath(),{stdout:o}=await P(r,["-"]);return{data:o,format:"png"}}};var Ne={png:"PNGf",jpeg:"JPEG",tiff:"TIFF"},K=class{requiredTool(){return"osascript (built-in)"}async isToolAvailable(){return process.platform==="darwin"}async hasImage(){try{let e=await j();return U(e).length>0}catch{return!1}}async detectFormat(){let e=await j(),r=U(e);if(r.length>0)return r[0];throw new Error("No image found in clipboard")}async readImage(){let e=await this.detectFormat(),r=e in Ne,o=r?Ne[e]:"PNGf",a=r?e:"png",{stdout:s}=await P("osascript",["-e",`set imgData to (the clipboard as \xABclass ${o}\xBB)`,"-e","return imgData"]);return{data:s,format:a}}};var De=[["image/png","png"],["image/jpeg","jpeg"],["image/webp","webp"],["image/tiff","tiff"],["image/bmp","bmp"],["image/x-bmp","bmp"]];function Ft(t){for(let[e,r]of De)if(t.includes(e))return r;return/^image\//m.test(t)?"unknown":null}function Ct(t){for(let[e,r]of De)if(t.includes(e))return{mime:e,format:r};return/^image\//m.test(t)?{mime:"image/png",format:"unknown"}:null}var $=class{displayServer;resolvedToolPath;constructor(e){this.displayServer=e}isWayland(){return this.displayServer==="wayland"}toolName(){return this.isWayland()?"wl-paste":"xclip"}async getToolPath(){return this.resolvedToolPath===void 0&&(this.resolvedToolPath=await A(this.toolName())),this.resolvedToolPath}requiredTool(){return this.isWayland()?"wl-clipboard (wl-paste)":"xclip"}async isToolAvailable(){try{return this.isWayland()?await d("which",["wl-paste"]):await d("which",["xclip"]),!0}catch{return!1}}async getClipboardTypes(){let e=await this.getToolPath();if(this.isWayland()){let{stdout:r}=await d(e,["--list-types"]);return r}else{let{stdout:r}=await d(e,["-selection","clipboard","-t","TARGETS","-o"]);return r}}async hasImage(){try{let e=await this.getClipboardTypes();return/^image\//m.test(e)}catch{return!1}}async detectFormat(){let e=await this.getClipboardTypes(),r=Ft(e);if(r!==null)return r;throw new Error("No image found in clipboard")}async readImage(){let e=await this.getClipboardTypes(),r=Ct(e);if(!r)throw new Error("No image found in clipboard");let{mime:o,format:a}=r,s=a==="unknown"?"png":a,n=await this.getToolPath(),{stdout:i}=this.isWayland()?await P(n,["--type",o]):await P(n,["-selection","clipboard","-t",o,"-o"]);return{data:i,format:s}}};var he=p(require("fs"));function F(t){return Buffer.from(t,"utf16le").toString("base64")}var Tt="Add-Type -AssemblyName System.Windows.Forms; if ([System.Windows.Forms.Clipboard]::ContainsImage()) { echo 'yes' } else { echo 'no' }",Et="Add-Type -AssemblyName System.Windows.Forms; $img = [System.Windows.Forms.Clipboard]::GetImage(); if ($img -eq $null) { exit 1 }; $tmp = [System.IO.Path]::GetTempFileName(); $img.Save($tmp, [System.Drawing.Imaging.ImageFormat]::Png); Write-Output $tmp",N=class{async isToolAvailable(){try{return await d(this.powershellExe,["-Command","echo ok"]),!0}catch{return!1}}async hasImage(){try{return(await d(this.powershellExe,["-EncodedCommand",F(Tt)])).stdout.trim()==="yes"}catch{return!1}}async detectFormat(){if(!await this.hasImage())throw new Error("No image found in clipboard");return"png"}async readImage(){let e;try{e=(await d(this.powershellExe,["-EncodedCommand",F(Et)])).stdout.trim()}catch(o){throw new Error(`PowerShell execution failed: ${o instanceof Error?o.message:o}`)}let r=await this.resolveTempPath(e);try{return{data:await he.promises.readFile(r),format:"png"}}catch(o){throw new Error(`Temp file read failed: could not read "${r}": ${o instanceof Error?o.message:o}`)}finally{he.promises.unlink(r).catch(o=>{l.warn(`Failed to clean up temp file: ${r}`,o)})}}};var ee=class extends N{resolvedPsPath;get powershellExe(){return this.resolvedPsPath??"powershell.exe"}async resolvePs(){this.resolvedPsPath===void 0&&(this.resolvedPsPath=await A("powershell.exe"))}requiredTool(){return"PowerShell (built-in)"}async isToolAvailable(){return await this.resolvePs(),super.isToolAvailable()}async resolveTempPath(e){return e}};var q=class extends N{psPath;constructor(e){super(),this.psPath=e.powershellPath??"powershell.exe"}get powershellExe(){return this.psPath}requiredTool(){return"PowerShell (via WSL interop)"}async resolveTempPath(e){try{return(await d("wslpath",["-u",e])).stdout.trim()}catch(r){throw new Error(`wslpath conversion failed: could not convert "${e}" to a WSL path: ${r instanceof Error?r.message:r}`)}}};var y=class{readers;constructor(e){if(e.length===0)throw new Error("FallbackClipboardReader requires at least one reader");this.readers=e}getReaders(){return this.readers}requiredTool(){return this.readers.map(e=>e.requiredTool()).join(" or ")}async isToolAvailable(){for(let e of this.readers)if(await e.isToolAvailable())return!0;return!1}async hasImage(){for(let e of this.readers)try{if(await e.hasImage())return!0}catch(r){l.warn(`Clipboard reader ${e.requiredTool()} failed hasImage()`,r)}return!1}async detectFormat(){let e=[];for(let r of this.readers)try{return await r.detectFormat()}catch(o){e.push(o instanceof Error?o:new Error(String(o)))}throw new AggregateError(e,`All clipboard readers failed to detect format: ${e.map(r=>r.message).join("; ")}`)}async readImage(){let e=[];for(let r of this.readers)try{return await r.readImage()}catch(o){e.push(o instanceof Error?o:new Error(String(o)))}throw new AggregateError(e,`All clipboard readers failed: ${e.map(r=>r.message).join("; ")}`)}};var We=p(require("fs")),Me=p(require("path"));var $t={".png":"png",".jpg":"jpeg",".jpeg":"jpeg",".bmp":"bmp",".webp":"webp",".tiff":"tiff",".tif":"tiff",".gif":"gif"};function Rt(t){let e=new URL(t);return decodeURIComponent(e.pathname)}var D=class{findFirstImageFile(e){for(let r of e){let o=Me.extname(r).toLowerCase(),a=$t[o];if(a)return{filePath:r,format:a}}return null}async hasImage(){try{let e=await this.getFilePaths();return this.findFirstImageFile(e)!==null}catch{return!1}}async detectFormat(){let e=await this.getFilePaths(),r=this.findFirstImageFile(e);if(r)return r.format;throw new Error("No image file path found in clipboard")}async readImage(){let e=await this.getFilePaths(),r=this.findFirstImageFile(e);if(!r)throw new Error("No image file path found in clipboard");return{data:await We.promises.readFile(r.filePath),format:r.format}}},W=class extends D{displayServer;constructor(e){super(),this.displayServer=e}isWayland(){return this.displayServer==="wayland"}requiredTool(){return this.isWayland()?"wl-clipboard (wl-paste) [file paths]":"xclip [file paths]"}async isToolAvailable(){try{let e=this.isWayland()?"wl-paste":"xclip";return await d("which",[e]),!0}catch{return!1}}async getFilePaths(){let{stdout:e}=this.isWayland()?await d("wl-paste",["--type","text/uri-list"]):await d("xclip",["-selection","clipboard","-t","text/uri-list","-o"]);return e.split(`
`).map(r=>r.trim()).filter(r=>r.startsWith("file://")).map(Rt)}},Be="Add-Type -AssemblyName System.Windows.Forms; $files = [System.Windows.Forms.Clipboard]::GetFileDropList(); foreach ($f in $files) { Write-Output $f }",te=class extends D{requiredTool(){return"PowerShell (built-in) [file paths]"}async isToolAvailable(){try{return await d("powershell.exe",["-Command","echo ok"]),!0}catch{return!1}}async getFilePaths(){let{stdout:e}=await d("powershell.exe",["-EncodedCommand",F(Be)]);return e.split(`
`).map(r=>r.trim()).filter(r=>r.length>0)}},G=class extends D{psPath;constructor(e){super(),this.psPath=e.powershellPath??"powershell.exe"}requiredTool(){return"PowerShell (via WSL interop) [file paths]"}async isToolAvailable(){try{return await d(this.psPath,["-Command","echo ok"]),!0}catch{return!1}}async getFilePaths(){let{stdout:e}=await d(this.psPath,["-EncodedCommand",F(Be)]),r=e.split(`
`).map(a=>a.trim()).filter(a=>a.length>0),o=[];for(let a of r)try{let{stdout:s}=await d("wslpath",["-u",a]);o.push(s.trim())}catch(s){l.warn(`wslpath conversion failed for "${a}":`,s)}return o}},re=class extends D{requiredTool(){return"osascript (built-in) [file paths]"}async isToolAvailable(){return process.platform==="darwin"}async getFilePaths(){let{stdout:e}=await d("osascript",["-e","try","-e","  set fileList to (the clipboard as \xABclass furl\xBB)","-e","  return POSIX path of fileList","-e","on error","-e",'  return ""',"-e","end try"]),r=e.trim();return r?[r]:[]}};function _e(t){if(t.isWSL){let e=t.displayServer==="x11"||t.displayServer==="wayland";if(t.hasWslg&&e)return new y([new $(t.displayServer),new q(t),new W(t.displayServer),new G(t)]);let r=[new q(t)];return e&&r.push(new $(t.displayServer)),r.push(new G(t)),e&&r.push(new W(t.displayServer)),new y(r)}switch(t.os){case"macos":return new y([new Q,new K,new re]);case"windows":return new y([new ee,new te]);case"linux":{let e=new $(t.displayServer),r=t.displayServer==="wayland"?"x11":"wayland",o=new $(r);return new y([e,o,new W(t.displayServer)])}}}var Ge=p(require("crypto")),g=p(require("fs")),h=p(require("path")),ye=p(require("vscode"));var we=p(require("fs")),Oe=p(require("path")),Le=100;async function oe(t,e){try{return await we.promises.writeFile(t,e,{flag:"wx",mode:384}),t}catch(a){if(a.code!=="EEXIST")throw a}let r=Oe.extname(t),o=t.slice(0,t.length-r.length);for(let a=1;a<=Le;a++){let s=`${o}-${a}${r}`;try{return await we.promises.writeFile(s,e,{flag:"wx",mode:384}),s}catch(n){if(n.code!=="EEXIST")throw n}}throw new Error(`Unable to write file after ${Le} retries: ${t}`)}var kt=".tip-images",ze=[".png",".jpg",".jpeg",".tiff",".tif",".bmp",".webp",".gif"];function At(t){switch(t){case"jpeg":return".jpg";case"tiff":return".tiff";case"bmp":return".bmp";case"webp":return".webp";case"gif":return".gif";case"png":case"unknown":default:return".png"}}var ve=Buffer.from([137,80,78,71,13,10,26,10]);function Nt(t,e){switch(e){case"png":if(t.length<ve.length||!t.subarray(0,ve.length).equals(ve))throw new Error("Clipboard data is not a valid PNG image");break;case"jpeg":if(t.length<2||t[0]!==255||t[1]!==216)throw new Error("Clipboard data is not a valid JPEG image");break;case"bmp":if(t.length<2||t[0]!==66||t[1]!==77)throw new Error("Clipboard data is not a valid BMP image");break;case"webp":if(t.length<12||t.subarray(0,4).toString("ascii")!=="RIFF"||t.subarray(8,12).toString("ascii")!=="WEBP")throw new Error("Clipboard data is not a valid WebP image");break;case"tiff":if(t.length<2||!(t[0]===73&&t[1]===73||t[0]===77&&t[1]===77))throw new Error("Clipboard data is not a valid TIFF image");break;case"gif":if(t.length<3||t.subarray(0,3).toString("ascii")!=="GIF")throw new Error("Clipboard data is not a valid GIF image");break;case"unknown":l.warn("Skipping image validation for unknown format");break}}function z(){return ye.workspace.getConfiguration("terminalImgPaste")}function Pe(){let t=ye.workspace.workspaceFolders;if(!t||t.length===0)throw new Error("No workspace folder is open. Please open a folder first.");return t[0].uri.fsPath}function Ye(){return z().get("folderName",kt)}function je(){let t=Pe(),e=Ye(),r=h.resolve(t,e);if(!r.startsWith(t+h.sep))throw new Error(`Configured folderName "${e}" must resolve to a subdirectory of the workspace root`);return r}var Ve="img-{timestamp}",Ue=["{timestamp}","{n}","{hash}"];function Dt(t,e,r){t||(t=Ve);let o=new Date;if(t.includes("{"))Ue.some(n=>t.includes(n))||l.warn(`Filename pattern "${t}" lacks a uniqueness placeholder (${Ue.join(", ")}). Filenames may collide.`);else{let n=qe(o);t=`${t}-${n}`}let s=t;if(s=s.replace(/\{timestamp\}/g,qe(o)),s=s.replace(/\{date\}/g,ae(o)),s=s.replace(/\{time\}/g,He(o)),s.includes("{hash}")){let n=Ge.createHash("sha256").update(e).digest("hex").slice(0,8);s=s.replace(/\{hash\}/g,n)}return s.includes("{n}")&&(s=Wt(s,r)),s}function qe(t){let e=String(t.getMilliseconds()).padStart(3,"0");return`${ae(t)}T${He(t)}-${e}`}function ae(t){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${e}-${r}-${o}`}function He(t){let e=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0");return`${e}-${r}-${o}`}function Wt(t,e){let r=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/\\{n\\}/g,"(\\d+)"),o=new RegExp(`^${r}`),a=0;for(let s of e){let i=s.replace(/\.[^.]+$/,"").match(o);if(i&&i[1]){let m=parseInt(i[1],10);m>a&&(a=m)}}return t.replace(/\{n\}/g,String(a+1))}function Mt(t,e,r){let o=z().get("filenamePattern",Ve),a=Dt(o,e,r),s=At(t);return`${a}${s}`}async function be(t,e){let r=await g.promises.realpath(t),o=await g.promises.realpath(e),a=process.platform==="win32"||process.platform==="darwin",s=a?r.toLowerCase():r,n=a?o.toLowerCase():o;if(s!==n&&!s.startsWith(n+h.sep))throw new Error(`Image folder resolves to a path outside the workspace (possible symlink escape): ${r}`);return r}function Bt(t,e=new Date){switch(t){case"daily":return ae(e);case"monthly":return ae(e).substring(0,7);case"flat":default:return""}}async function se(t){let e=[],r;try{r=await g.promises.readdir(t,{withFileTypes:!0})}catch{return e}for(let o of r){let a=h.join(t,o.name);o.isDirectory()&&!o.isSymbolicLink()?e.push(...await se(a)):!o.isSymbolicLink()&&ze.some(s=>o.name.endsWith(s))&&e.push({filePath:a,name:o.name})}return e}async function _t(t,e){if(t!==e)try{(await g.promises.readdir(t)).length===0&&(await g.promises.rmdir(t),l.info(`Removed empty directory: ${t}`))}catch(r){l.warn(`Failed to remove empty directory ${t}:`,r)}}function Xe(){return{async save(t,e="png"){if(t.length===0)throw new Error("Cannot save empty image data");Nt(t,e);let r=je(),o=Pe();await g.promises.mkdir(r,{recursive:!0}),await be(r,o);let a=z().get("organizeFolders","flat"),s=Bt(a),n=s?h.join(r,s):r;s&&(await g.promises.mkdir(n,{recursive:!0}),await be(n,o));let i;try{i=await g.promises.readdir(n)}catch{i=[]}let m=Mt(e,t,i),c=h.join(n,m),f=await oe(c,t);return await be(f,o),l.info(`Saved image: ${f}`),await this.cleanup(),await this.ensureGitIgnored(),f},async cleanup(){let t=z(),e=t.get("maxImages",20),r=Number.isInteger(e)&&e>0?e:20,o=t.get("organizeFolders","flat"),a=je();if(o==="flat"){let s;try{s=await g.promises.readdir(a)}catch{return}let n=s.filter(m=>ze.some(c=>m.endsWith(c))).sort();if(n.length<=r)return;let i=n.slice(0,n.length-r);for(let m of i){let c=h.join(a,m);try{await g.promises.unlink(c),l.info(`Deleted old image: ${c}`)}catch(f){l.warn(`Failed to delete old image: ${c}`,f)}}}else{let s=await se(a);if(s.sort((m,c)=>m.name.localeCompare(c.name)),s.length<=r)return;let n=s.slice(0,s.length-r),i=new Set;for(let m of n)try{await g.promises.unlink(m.filePath),l.info(`Deleted old image: ${m.filePath}`),i.add(h.dirname(m.filePath))}catch(c){l.warn(`Failed to delete old image: ${m.filePath}`,c)}for(let m of i)await _t(m,a)}},async ensureGitIgnored(){if(!z().get("autoGitIgnore",!0))return;let e=Ye(),r=Pe(),o=h.join(r,".gitignore"),a;try{a=await g.promises.readFile(o,"utf-8")}catch{await g.promises.writeFile(o,e+`
`,"utf-8"),l.info(`Created .gitignore with ${e}`);return}if(a.split(`
`).map(i=>i.trim()).includes(e))return;let n=a.endsWith(`
`)?"":`
`;await g.promises.writeFile(o,a+n+e+`
`,"utf-8"),l.info(`Added ${e} to .gitignore`)}}}var Y=p(require("vscode"));var Ze=p(require("path")),Lt=[{pattern:/\bbash\b/i,type:"bash"},{pattern:/\bzsh\b/i,type:"zsh"},{pattern:/\bfish\b/i,type:"fish"},{pattern:/\b(?:pwsh|powershell)\b/i,type:"powershell"},{pattern:/\bcmd\b/i,type:"cmd"}];function Je(t){let e=Ze.basename(t).replace(/\.exe$/i,"");for(let{pattern:r,type:o}of Lt)if(r.test(e))return o;return"unknown"}function ne(t){let e=t.creationOptions?.shellPath;if(e)return Je(e);let r=process.env.SHELL;return r?Je(r):process.platform==="win32"?"powershell":"unknown"}function Ot(t,e){switch(e){case"fish":return"'"+t.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'";case"powershell":return'"'+t.replace(/`/g,"``").replace(/\$/g,"`$").replace(/"/g,'`"')+'"';case"cmd":return'"'+t.replace(/%/g,"%%").replace(/"/g,'""')+'"';case"bash":case"zsh":case"unknown":default:return"'"+t.replace(/'/g,"'\\''")+"'"}}function R(t){let e=Y.window.activeTerminal;if(!e){Y.window.showErrorMessage("Terminal Image Paste: No active terminal. Please open a terminal first.");return}let r=ne(e),o=Ot(t,r),s=Y.workspace.getConfiguration("terminalImgPaste").get("sendNewline",!1);e.sendText(o,s),l.info(`Inserted path into terminal (${r}): ${o}`)}var ie=p(require("fs")),Qe=p(require("os")),xe=p(require("path"));async function M(t,e,r,o){if(r==="auto"||e===r)return{data:t,format:e};try{return{data:await Ut(t,e,r,o),format:r}}catch(a){return l.warn(`Image conversion from ${e} to ${r} failed, saving in native format: ${a instanceof Error?a.message:String(a)}`),{data:t,format:e}}}async function jt(t){if(t.os==="macos")return"sips";if(t.os==="windows"||t.isWSL)return t.powershellPath?"powershell":null;try{return await d("which",["convert"]),"magick"}catch{}try{return await d("which",["ffmpeg"]),"ffmpeg"}catch{}return null}async function Ut(t,e,r,o){let a=await jt(o);if(a===null)throw new Error("No conversion tool available");switch(a){case"sips":return qt(t,r);case"magick":return Gt(t,e,r);case"ffmpeg":return zt(t,r);case"powershell":return Yt(t,r,o.powershellPath)}}async function qt(t,e){let r=Qe.tmpdir(),o=xe.join(r,`tip-convert-in-${Date.now()}`),a=e==="jpeg"?"jpg":"png",s=xe.join(r,`tip-convert-out-${Date.now()}.${a}`),n=await oe(o,t);try{return await d("sips",["--setProperty","format",e==="jpeg"?"jpeg":"png",n,"--out",s]),await ie.promises.readFile(s)}finally{await ie.promises.unlink(n).catch(()=>{}),await ie.promises.unlink(s).catch(()=>{})}}async function Gt(t,e,r){let o=e==="unknown"?"-":`${e}:-`,a=`${r}:-`;return(await P("convert",[o,a],{input:t})).stdout}async function zt(t,e){return(await P("ffmpeg",["-hide_banner","-loglevel","error","-f","image2pipe","-i","-","-f","image2","-c:v",e==="png"?"png":"mjpeg","-"],{input:t})).stdout}async function Yt(t,e,r){return(await P(r,["-NoProfile","-EncodedCommand",F(`
Add-Type -AssemblyName System.Drawing
$stdin = [Console]::OpenStandardInput()
$ms = New-Object System.IO.MemoryStream
$stdin.CopyTo($ms)
$ms.Position = 0
$img = [System.Drawing.Image]::FromStream($ms)
$outMs = New-Object System.IO.MemoryStream
$img.Save($outMs, [System.Drawing.Imaging.ImageFormat]::${e==="png"?"Png":"Jpeg"})
[Console]::OpenStandardOutput().Write($outMs.ToArray(), 0, $outMs.Length)
$img.Dispose()
$ms.Dispose()
$outMs.Dispose()
`)],{input:t})).stdout}var le=p(require("vscode")),Ke=1e4;function et(t,e){return new Promise(r=>{let o=!1,a,s=c=>{o||(o=!0,clearTimeout(a),n.dispose(),r(c))},n=le.window.createWebviewPanel("terminalImgPaste.preview","Image Preview \u2014 Terminal Image Paste",le.ViewColumn.Active,{enableScripts:!0}),i=e==="unknown"?"image/png":`image/${e}`,m=t.toString("base64");n.webview.html=Vt(i,m,Ke),n.webview.onDidReceiveMessage(c=>{c.command==="paste"?s(!0):(c.command==="cancel"||c.command==="timeout")&&s(!1)}),n.onDidDispose(()=>{s(!1)}),a=setTimeout(()=>{s(!1)},Ke+500)})}function Vt(t,e,r){let o=Math.round(r/1e3);return`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; img-src data:; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Preview</title>
  <style>
    body { font-family: var(--vscode-font-family, sans-serif); padding: 16px; text-align: center; color: var(--vscode-foreground); background: var(--vscode-editor-background); }
    img { max-width: 100%; max-height: 60vh; border: 1px solid var(--vscode-panel-border, #444); margin-bottom: 12px; }
    .info { margin-bottom: 16px; opacity: 0.8; font-size: 13px; }
    .buttons { display: flex; justify-content: center; gap: 12px; }
    button { padding: 8px 20px; font-size: 14px; cursor: pointer; border: none; border-radius: 4px; }
    .btn-paste { background: var(--vscode-button-background, #0078d4); color: var(--vscode-button-foreground, #fff); }
    .btn-paste:hover { background: var(--vscode-button-hoverBackground, #005a9e); }
    .btn-cancel { background: var(--vscode-button-secondaryBackground, #333); color: var(--vscode-button-secondaryForeground, #fff); }
    .btn-cancel:hover { background: var(--vscode-button-secondaryHoverBackground, #444); }
    .countdown { margin-top: 12px; font-size: 12px; opacity: 0.6; }
  </style>
</head>
<body>
  <img id="preview" src="data:${t};base64,${e}" alt="Clipboard image preview"
       onload="document.getElementById('dims').textContent = this.naturalWidth + ' \xD7 ' + this.naturalHeight + ' px';" />
  <div class="info" id="dims"></div>
  <div class="buttons">
    <button class="btn-paste" id="pasteBtn">Paste</button>
    <button class="btn-cancel" id="cancelBtn">Cancel</button>
  </div>
  <div class="countdown" id="timer">Auto-cancel in ${o}s</div>
  <script>
    const vscode = acquireVsCodeApi();
    document.getElementById('pasteBtn').addEventListener('click', () => vscode.postMessage({ command: 'paste' }));
    document.getElementById('cancelBtn').addEventListener('click', () => vscode.postMessage({ command: 'cancel' }));

    let remaining = ${o};
    const timerEl = document.getElementById('timer');
    const interval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(interval);
        timerEl.textContent = 'Auto-cancelled';
        vscode.postMessage({ command: 'timeout' });
      } else {
        timerEl.textContent = 'Auto-cancel in ' + remaining + 's';
      }
    }, 1000);
  </script>
</body>
</html>`}var _=p(require("vscode")),tt=p(require("path"));var k=p(require("vscode"));function ce(){return k.workspace.getConfiguration("terminalImgPaste").get("notifications","all")}function Ht(){return{statusBar(t,e=3e3){l.info(t),ce()==="all"&&k.window.setStatusBarMessage(t,e)},info(t){l.info(t),ce()==="all"&&k.window.showInformationMessage(t)},async warning(t,...e){return l.warn(t),ce()==="all"?k.window.showWarningMessage(t,...e):e.length>0?e[0]:void 0},error(t){l.error(t);let e=ce();(e==="all"||e==="errors")&&k.window.showErrorMessage(t)}}}var v=Ht();var B=class{_queue=[];_locked=!1;acquire(){return new Promise(e=>{let r=()=>{this._locked?this._queue.push(r):(this._locked=!0,e(()=>{this._locked=!1;let o=this._queue.shift();o&&o()}))};r()})}};var Xt={"image/png":"png","image/jpeg":"jpeg","image/gif":"png","image/bmp":"bmp","image/webp":"webp","image/svg+xml":"png"},Jt=50*1024*1024,me=class{constructor(e,r,o,a){this.imageStore=r;this.pasteEmitter=o;this._extensionUri=e,this._mutex=a??new B}_extensionUri;_mutex;resolveWebviewView(e,r,o){e.webview.options={enableScripts:!0,localResourceRoots:[_.Uri.joinPath(this._extensionUri,"media")]},e.webview.html=this._getHtml(e.webview),e.webview.onDidReceiveMessage(a=>{this._handleMessage(a,e.webview).catch(s=>{l.error("Drop zone: unhandled message error",s)})})}async _handleMessage(e,r){if(e.type!=="files-dropped")return;let o=e.files;if(!o||o.length===0)return;let a=await this._mutex.acquire();try{await this._processDroppedFiles(o,r)}finally{a()}}async _processDroppedFiles(e,r){let a=_.workspace.getConfiguration("terminalImgPaste").get("saveFormat","auto"),s=J();for(let n of e)try{let i=Xt[n.mimeType];if(!i){r.postMessage({type:"drop-result",success:!1,message:`Unsupported file type: ${n.mimeType}`}),l.warn(`Rejected drop: unsupported MIME type ${n.mimeType}`);continue}let m=Buffer.from(n.data,"base64");if(m.length>Jt){r.postMessage({type:"drop-result",success:!1,message:"File too large (max 50 MB)"}),l.warn(`Rejected drop: file too large (${m.length} bytes)`);continue}if(m.length===0){r.postMessage({type:"drop-result",success:!1,message:"Empty file data"});continue}let c=await M(m,i,a,s),f=await this.imageStore.save(c.data,c.format);R(f),this.pasteEmitter.fire({path:f,format:c.format}),r.postMessage({type:"drop-result",success:!0,message:`Saved: ${tt.basename(f)}`}),v.statusBar("Image dropped and saved",3e3),l.info(`Drop zone: saved ${n.name} as ${f}`)}catch(i){let m=i instanceof Error?i.message:String(i);r.postMessage({type:"drop-result",success:!1,message:`Failed: ${m}`}),l.error(`Drop zone: failed to process ${n.name}`,i)}}_getHtml(e){let r=e.asWebviewUri(_.Uri.joinPath(this._extensionUri,"media","dropZone.css")),o=e.asWebviewUri(_.Uri.joinPath(this._extensionUri,"media","dropZone.js"));return`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; style-src ${e.cspSource}; script-src ${e.cspSource};">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="${r}">
  <title>Drop Zone</title>
</head>
<body>
  <div id="drop-zone" class="drop-zone">
    <div class="drop-icon">&#128247;</div>
    <div class="drop-text">Drop images here</div>
  </div>
  <div id="status" class="status-message"></div>
  <script src="${o}"></script>
</body>
</html>`}};var rt=p(require("path")),C=p(require("vscode"));async function Zt(t){return(await se(t)).length}async function Qt(t,e){let r=C.workspace.getConfiguration("terminalImgPaste"),o={os:t.os,isWsl:t.isWSL,wslVersion:t.isWSL?`WSL${t.wslVersion??"?"}`:"N/A",hasWslg:t.isWSL?t.hasWslg?"Yes":"No":"N/A",displayServer:t.displayServer,powershellPath:t.powershellPath??"N/A"},a=e instanceof y?[...e.getReaders()]:[e],s=[];for(let E of a){let V=E.constructor.name;try{let I=await E.isToolAvailable();s.push({name:V,available:I?"Yes":"No"})}catch(I){s.push({name:V,available:`Error: ${I instanceof Error?I.message:String(I)}`})}}let n="N/A";try{n=await e.detectFormat()}catch(E){n=`Error: ${E instanceof Error?E.message:String(E)}`}let i=C.workspace.workspaceFolders,m=i?.[0]?.uri.fsPath??"None",c=r.get("folderName",".tip-images"),f=i?rt.join(m,c):"N/A",w=r.get("maxImages",20),b=i?await Zt(f):0,T=C.window.activeTerminal,u=T?ne(T):"No active terminal",S=Z();return{platform:o,clipboard:{readers:s,detectedFormat:n},storage:{workspaceFolder:m,imageFolder:f,imageCount:`${b} / ${w}`,organizeFolders:r.get("organizeFolders","flat"),filenamePattern:r.get("filenamePattern","img-{timestamp}")},settings:{maxImages:w,autoGitIgnore:r.get("autoGitIgnore",!0),sendNewline:r.get("sendNewline",!1),showPreview:r.get("showPreview",!1),notifications:r.get("notifications","all"),saveFormat:r.get("saveFormat","auto"),folderName:c,warnOnRemote:r.get("warnOnRemote",!0)},terminal:{activeShell:u,isRemote:S.remote,remoteName:S.remote?S.type:"N/A"}}}function Kt(t){let e=[];e.push("# Terminal Image Paste \u2014 Diagnostics"),e.push(""),e.push("## Platform"),e.push("| Property | Value |"),e.push("|----------|-------|"),e.push(`| OS | ${t.platform.os} |`),e.push(`| WSL | ${t.platform.isWsl?`Yes (${t.platform.wslVersion})`:"No"} |`),t.platform.isWsl&&e.push(`| WSLg | ${t.platform.hasWslg} |`),e.push(`| Display Server | ${t.platform.displayServer} |`),t.platform.powershellPath!=="N/A"&&e.push(`| PowerShell Path | ${t.platform.powershellPath} |`),e.push(""),e.push("## Clipboard"),e.push("| Reader | Available |"),e.push("|--------|-----------|");for(let r of t.clipboard.readers)e.push(`| ${r.name} | ${r.available} |`);return e.push(`| Detected Format | ${t.clipboard.detectedFormat} |`),e.push(""),e.push("## Storage"),e.push("| Property | Value |"),e.push("|----------|-------|"),e.push(`| Workspace Folder | ${t.storage.workspaceFolder} |`),e.push(`| Image Folder | ${t.storage.imageFolder} |`),e.push(`| Image Count | ${t.storage.imageCount} |`),e.push(`| Organization | ${t.storage.organizeFolders} |`),e.push(`| Filename Pattern | ${t.storage.filenamePattern} |`),e.push(""),e.push("## Settings"),e.push("| Setting | Value |"),e.push("|---------|-------|"),e.push(`| maxImages | ${t.settings.maxImages} |`),e.push(`| autoGitIgnore | ${t.settings.autoGitIgnore} |`),e.push(`| sendNewline | ${t.settings.sendNewline} |`),e.push(`| showPreview | ${t.settings.showPreview} |`),e.push(`| notifications | ${t.settings.notifications} |`),e.push(`| saveFormat | ${t.settings.saveFormat} |`),e.push(`| warnOnRemote | ${t.settings.warnOnRemote} |`),e.push(""),e.push("## Terminal"),e.push("| Property | Value |"),e.push("|----------|-------|"),e.push(`| Active Shell | ${t.terminal.activeShell} |`),e.push(`| Remote | ${t.terminal.isRemote?"Yes":"No"} |`),t.terminal.isRemote&&e.push(`| Remote Name | ${t.terminal.remoteName} |`),e.push(""),e.push("---"),e.push(`*Generated at ${new Date().toISOString()}*`),e.push(""),e.join(`
`)}async function ot(t,e){try{let r=await Qt(t,e),o=Kt(r),a=await C.workspace.openTextDocument({content:o,language:"markdown"});await C.window.showTextDocument(a),l.info("Diagnostics report generated")}catch(r){let o=r instanceof Error?r.message:String(r);l.error("Failed to generate diagnostics report",r),C.window.showErrorMessage(`Terminal Image Paste: Failed to generate diagnostics \u2014 ${o}`)}}var de=p(require("vscode")),at=p(require("path"));function st(t,e,r,o){return{async pasteFromClipboard(){if(!await e.hasImage())return;let{data:s,format:n}=await e.readImage(),m=de.workspace.getConfiguration("terminalImgPaste").get("saveFormat","auto"),c=await M(s,n,m,t),w={path:await r.save(c.data,c.format),format:c.format};return o.fire(w),w},sendPathToTerminal(a){R(a)},getImageFolder(){let a=de.workspace.workspaceFolders;if(!a||a.length===0)return;let n=de.workspace.getConfiguration("terminalImgPaste").get("folderName",".tip-images");return at.resolve(a[0].uri.fsPath,n)},onImagePasted:o.event}}function nt(t,e){let r=e instanceof Error?e.message:String(e);v.error(`Terminal Image Paste: ${r}`),l.error(`${t} command failed`,e)}function er(t){let e=J(),r=_e(e),o=Xe(),a=new x.EventEmitter;t.subscriptions.push(a),r.isToolAvailable().then(c=>{c||v.warning(`Terminal Image Paste: clipboard tool "${r.requiredTool()}" not found. Install it to use clipboard image pasting.`)}).catch(c=>{l.error("Failed to check tool availability",c)});let s=new B,n=x.commands.registerCommand("terminalImgPaste.pasteImage",async()=>{let c=await s.acquire();try{if(!await r.isToolAvailable()){v.warning(`Terminal Image Paste: "${r.requiredTool()}" is not installed. Please install it to paste clipboard images.`);return}let w=x.workspace.getConfiguration("terminalImgPaste");if(w.get("warnOnRemote",!0)){let pe=Z();if(pe.remote&&pe.type!=="wsl"&&await v.warning("Clipboard images are saved locally. The pasted path may not be accessible from the remote terminal.","Paste Anyway","Cancel")!=="Paste Anyway")return}if(!await r.hasImage()){v.info("No image found in clipboard.");return}let{data:u,format:S}=await r.readImage();if(w.get("showPreview",!1)&&!await et(u,S)){v.statusBar("Image paste cancelled",3e3);return}let V=w.get("saveFormat","auto"),I=await M(u,S,V,e),Se=await o.save(I.data,I.format);R(Se),a.fire({path:Se,format:I.format}),v.statusBar("Image pasted to terminal",3e3)}catch(f){nt("pasteImage",f)}finally{c()}}),i=x.commands.registerCommand("terminalImgPaste.sendPathToTerminal",async c=>{try{if(!c?.fsPath){v.error("Terminal Image Paste: No file selected.");return}R(c.fsPath),v.statusBar("Path sent to terminal",3e3)}catch(f){nt("sendPathToTerminal",f)}}),m=x.commands.registerCommand("terminalImgPaste.showDiagnostics",()=>ot(e,r));for(let c of["terminalImgPaste.dropZone","terminalImgPaste.panelDropZone"]){let f=new me(t.extensionUri,o,a,s);t.subscriptions.push(x.window.registerWebviewViewProvider(c,f))}return t.subscriptions.push(n,i,m),l.info(`Extension activated (platform: ${e.os}, WSL: ${e.isWSL})`),st(e,r,o,a)}function tr(){l.info("Extension deactivating")}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
