"use strict";var oe=Object.create;var I=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var se=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty;var le=(t,e)=>{for(var r in e)I(t,r,{get:e[r],enumerable:!0})},L=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of ne(e))!ie.call(t,a)&&a!==r&&I(t,a,{get:()=>e[a],enumerable:!(o=ae(e,a))||o.enumerable});return t};var p=(t,e,r)=>(r=t!=null?oe(se(t)):{},L(e||!t||!t.__esModule?I(r,"default",{value:t,enumerable:!0}):r,t)),ce=t=>L(I({},"__esModule",{value:!0}),t);var $e={};le($e,{activate:()=>Ee,deactivate:()=>Fe});module.exports=ce($e);var d=p(require("vscode"));var T=p(require("fs")),C=null;function me(){switch(process.platform){case"darwin":return"macos";case"win32":return"windows";default:return"linux"}}function de(){try{let t=T.readFileSync("/proc/version","utf-8");return/microsoft/i.test(t)}catch{return!1}}function pe(t,e){if(t!=="linux")return"unknown";if(e)return process.env.WAYLAND_DISPLAY?"wayland":process.env.DISPLAY?"x11":"unknown";let r=process.env.XDG_SESSION_TYPE;return r==="wayland"?"wayland":r==="x11"?"x11":process.env.WAYLAND_DISPLAY?"wayland":"unknown"}function fe(t,e){if(t==="windows")return"powershell.exe";if(e){let r=["/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe","/mnt/c/Program Files/PowerShell/7/pwsh.exe"];for(let o of r)if(T.existsSync(o))return o;return"powershell.exe"}return null}function D(){if(C)return C;let t=me(),e=t==="linux"?de():!1,r=pe(t,e),o=fe(t,e);return C={os:t,isWSL:e,displayServer:r,powershellPath:o},C}var k=require("child_process"),q=1e4,ge=10*1024*1024,ue=50*1024*1024;function G(t){return"code"in t&&typeof t.code=="number"?t.code:t.code??"unknown"}function c(t,e,r){return new Promise((o,a)=>{(0,k.execFile)(t,e,{encoding:"utf-8",timeout:r?.timeout??q,maxBuffer:r?.maxBuffer??ge,cwd:r?.cwd},(s,m,n)=>{if(s){a(new Error(`Command "${t}" failed (exit code ${G(s)}): ${n||s.message}`));return}o({stdout:m,stderr:n})})})}function u(t,e,r){return new Promise((o,a)=>{(0,k.execFile)(t,e,{encoding:"buffer",timeout:r?.timeout??q,maxBuffer:r?.maxBuffer??ue,cwd:r?.cwd},(s,m,n)=>{let l=n instanceof Buffer?n.toString("utf-8"):String(n);if(s){a(new Error(`Command "${t}" failed (exit code ${G(s)}): ${l||s.message}`));return}o({stdout:m,stderr:l})})})}async function y(){let{stdout:t}=await c("osascript",["-e","clipboard info"]);return t}function P(t){let e=[];return t.includes("\xABclass PNGf\xBB")&&e.push("png"),(t.includes("\xABclass JPEG\xBB")||t.includes("\xABclass JPEf\xBB"))&&e.push("jpeg"),t.includes("\xABclass TIFF\xBB")&&e.push("tiff"),(t.includes("\xABclass BMP \xBB")||t.includes("\xABclass BMPf\xBB"))&&e.push("bmp"),e}var E=class{requiredTool(){return"pngpaste"}async isToolAvailable(){try{return await c("which",["pngpaste"]),!0}catch{return!1}}async hasImage(){try{let e=await y();return P(e).length>0}catch{return!1}}async detectFormat(){let e=await y(),r=P(e);if(r.length>0)return r[0];throw new Error("No image found in clipboard")}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let{stdout:r}=await u("pngpaste",["-"]);return{data:r,format:"png"}}};var O={png:"PNGf",jpeg:"JPEG",tiff:"TIFF"},F=class{requiredTool(){return"osascript (built-in)"}async isToolAvailable(){return process.platform==="darwin"}async hasImage(){try{let e=await y();return P(e).length>0}catch{return!1}}async detectFormat(){let e=await y(),r=P(e);if(r.length>0)return r[0];throw new Error("No image found in clipboard")}async readImage(){let e=await this.detectFormat(),r=e in O,o=r?O[e]:"PNGf",a=r?e:"png",{stdout:s}=await u("osascript",["-e",`set imgData to (the clipboard as \xABclass ${o}\xBB)`,"-e","return imgData"]);return{data:s,format:a}}};var j=[["image/png","png"],["image/jpeg","jpeg"],["image/webp","webp"],["image/tiff","tiff"],["image/bmp","bmp"],["image/x-bmp","bmp"]];function we(t){for(let[e,r]of j)if(t.includes(e))return r;return/^image\//m.test(t)?"unknown":null}var w=class{displayServer;constructor(e){this.displayServer=e}isWayland(){return this.displayServer==="wayland"}requiredTool(){return this.isWayland()?"wl-clipboard (wl-paste)":"xclip"}async isToolAvailable(){try{return this.isWayland()?await c("which",["wl-paste"]):await c("which",["xclip"]),!0}catch{return!1}}async getClipboardTypes(){if(this.isWayland()){let{stdout:e}=await c("wl-paste",["--list-types"]);return e}else{let{stdout:e}=await c("xclip",["-selection","clipboard","-t","TARGETS","-o"]);return e}}async hasImage(){try{let e=await this.getClipboardTypes();return/^image\//m.test(e)}catch{return!1}}async detectFormat(){let e=await this.getClipboardTypes(),r=we(e);if(r!==null)return r;throw new Error("No image found in clipboard")}formatToMime(e){let r=j.find(([,o])=>o===e);return r?r[0]:"image/png"}async readImage(){let e=await this.detectFormat(),r=this.formatToMime(e),o=e==="unknown"?"png":e,{stdout:a}=this.isWayland()?await u("wl-paste",["--type",r]):await u("xclip",["-selection","clipboard","-t",r,"-o"]);return{data:a,format:o}}};var M=p(require("fs"));var U=p(require("vscode"));function N(){let t=new Date,e=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0"),a=String(t.getMilliseconds()).padStart(3,"0");return`[${e}:${r}:${o}.${a}]`}function he(t){let e=U.window.createOutputChannel(t);return{info(r){e.appendLine(`${N()} [INFO] ${r}`)},warn(r,o){let a=`${N()} [WARN] ${r}`;o!==void 0&&(o instanceof Error&&o.stack?a+=`
${o.stack}`:a+=`
${String(o)}`),e.appendLine(a)},error(r,o){let a=`${N()} [ERROR] ${r}`;o!==void 0&&(o instanceof Error&&o.stack?a+=`
${o.stack}`:a+=`
${String(o)}`),e.appendLine(a)},show(){e.show()}}}var i=he("Terminal Image Paste");var be="Add-Type -AssemblyName System.Windows.Forms; if ([System.Windows.Forms.Clipboard]::ContainsImage()) { echo 'yes' } else { echo 'no' }",ye="Add-Type -AssemblyName System.Windows.Forms; $img = [System.Windows.Forms.Clipboard]::GetImage(); if ($img -eq $null) { exit 1 }; $tmp = [System.IO.Path]::GetTempFileName(); $img.Save($tmp, [System.Drawing.Imaging.ImageFormat]::Png); Write-Output $tmp",h=class{async isToolAvailable(){try{return await c(this.powershellExe,["-Command","echo ok"]),!0}catch{return!1}}async hasImage(){try{return(await c(this.powershellExe,["-Command",be])).stdout.trim()==="yes"}catch{return!1}}async detectFormat(){if(!await this.hasImage())throw new Error("No image found in clipboard");return"png"}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let r=await c(this.powershellExe,["-Command",ye]),o=await this.resolveTempPath(r.stdout.trim());try{return{data:await M.promises.readFile(o),format:"png"}}finally{M.promises.unlink(o).catch(a=>{i.warn(`Failed to clean up temp file: ${o}`,a)})}}};var $=class extends h{get powershellExe(){return"powershell.exe"}requiredTool(){return"PowerShell (built-in)"}async resolveTempPath(e){return e}};var R=class extends h{psPath;constructor(e){super(),this.psPath=e.powershellPath??"powershell.exe"}get powershellExe(){return this.psPath}requiredTool(){return"PowerShell (via WSL interop)"}async resolveTempPath(e){return(await c("wslpath",["-u",e])).stdout.trim()}};var b=class{readers;constructor(e){if(e.length===0)throw new Error("FallbackClipboardReader requires at least one reader");this.readers=e}requiredTool(){return this.readers.map(e=>e.requiredTool()).join(" or ")}async isToolAvailable(){for(let e of this.readers)if(await e.isToolAvailable())return!0;return!1}async hasImage(){for(let e of this.readers)try{if(await e.hasImage())return!0}catch{continue}return!1}async detectFormat(){let e=[];for(let r of this.readers)try{return await r.detectFormat()}catch(o){e.push(o instanceof Error?o:new Error(String(o)))}throw new AggregateError(e,`All clipboard readers failed to detect format: ${e.map(r=>r.message).join("; ")}`)}async readImage(){let e=[];for(let r of this.readers)try{if(!await r.isToolAvailable()){e.push(new Error(`${r.requiredTool()}: tool not available`));continue}return await r.readImage()}catch(o){e.push(o instanceof Error?o:new Error(String(o)))}throw new AggregateError(e,`All clipboard readers failed: ${e.map(r=>r.message).join("; ")}`)}};function Y(t){if(t.isWSL){let e=[new R(t)];return(t.displayServer==="x11"||t.displayServer==="wayland")&&e.push(new w(t.displayServer)),e.length===1?e[0]:new b(e)}switch(t.os){case"macos":return new b([new E,new F]);case"windows":return new $;case"linux":{let e=new w(t.displayServer),r=t.displayServer==="wayland"?"x11":"wayland",o=new w(r);return new b([e,o])}}}var f=p(require("fs")),g=p(require("path")),v=p(require("vscode"));var Pe=".tip-images",ve=[".png",".jpg",".jpeg",".tiff",".bmp",".webp"];function xe(t){switch(t){case"jpeg":return".jpg";case"tiff":return".tiff";case"bmp":return".bmp";case"webp":return".webp";case"png":case"unknown":default:return".png"}}var W=Buffer.from([137,80,78,71,13,10,26,10]);function Se(t,e){switch(e){case"png":if(t.length<W.length||!t.subarray(0,W.length).equals(W))throw new Error("Clipboard data is not a valid PNG image");break;case"jpeg":if(t.length<2||t[0]!==255||t[1]!==216)throw new Error("Clipboard data is not a valid JPEG image");break;case"bmp":if(t.length<2||t[0]!==66||t[1]!==77)throw new Error("Clipboard data is not a valid BMP image");break;case"webp":if(t.length<12||t.subarray(0,4).toString("ascii")!=="RIFF"||t.subarray(8,12).toString("ascii")!=="WEBP")throw new Error("Clipboard data is not a valid WebP image");break;case"tiff":if(t.length<2||!(t[0]===73&&t[1]===73||t[0]===77&&t[1]===77))throw new Error("Clipboard data is not a valid TIFF image");break;case"unknown":i.warn("Skipping image validation for unknown format");break}}function _(){return v.workspace.getConfiguration("terminalImgPaste")}function z(){let t=v.workspace.workspaceFolders;if(!t||t.length===0)throw v.window.showErrorMessage("Terminal Image Paste: No workspace folder is open. Please open a folder first."),new Error("No workspace folder is open");return t[0].uri.fsPath}function H(){return _().get("folderName",Pe)}function J(){let t=z(),e=H(),r=g.resolve(t,e);if(!r.startsWith(t+g.sep))throw new Error(`Configured folderName "${e}" must resolve to a subdirectory of the workspace root`);return r}function Ie(t){let e=new Date,r=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),m=String(e.getMinutes()).padStart(2,"0"),n=String(e.getSeconds()).padStart(2,"0"),l=String(e.getMilliseconds()).padStart(3,"0"),S=xe(t);return`img-${r}-${o}-${a}T${s}-${m}-${n}-${l}${S}`}function X(){return{async save(t,e="png"){Se(t,e);let r=J();await f.promises.mkdir(r,{recursive:!0});let o=Ie(e),a=g.join(r,o);return await f.promises.writeFile(a,t,{mode:384}),i.info(`Saved image: ${a}`),await this.cleanup(),await this.ensureGitIgnored(),a},async cleanup(){let e=_().get("maxImages",20),r=Number.isInteger(e)&&e>0?e:20,o=J(),a;try{a=await f.promises.readdir(o)}catch{return}let s=a.filter(n=>ve.some(l=>n.endsWith(l))).sort();if(s.length<=r)return;let m=s.slice(0,s.length-r);for(let n of m){let l=g.join(o,n);try{await f.promises.unlink(l),i.info(`Deleted old image: ${l}`)}catch(S){i.warn(`Failed to delete old image: ${l}`,S)}}},async ensureGitIgnored(){if(!_().get("autoGitIgnore",!0))return;let e=H(),r=z(),o=g.join(r,".gitignore"),a;try{a=await f.promises.readFile(o,"utf-8")}catch{await f.promises.writeFile(o,e+`
`,"utf-8"),i.info(`Created .gitignore with ${e}`);return}if(a.split(`
`).map(n=>n.trim()).includes(e))return;let m=a.endsWith(`
`)?"":`
`;await f.promises.writeFile(o,a+m+e+`
`,"utf-8"),i.info(`Added ${e} to .gitignore`)}}}var x=p(require("vscode"));var K=p(require("path")),Ce=[{pattern:/\bbash\b/i,type:"bash"},{pattern:/\bzsh\b/i,type:"zsh"},{pattern:/\bfish\b/i,type:"fish"},{pattern:/\b(?:pwsh|powershell)\b/i,type:"powershell"},{pattern:/\bcmd\b/i,type:"cmd"}];function V(t){let e=K.basename(t).replace(/\.exe$/i,"");for(let{pattern:r,type:o}of Ce)if(r.test(e))return o;return"unknown"}function Q(t){let e=t.creationOptions?.shellPath;if(e)return V(e);let r=process.env.SHELL;return r?V(r):process.platform==="win32"?"powershell":"unknown"}function Te(t,e){switch(e){case"fish":return"'"+t.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'";case"powershell":return'"'+t.replace(/`/g,"``").replace(/\$/g,"`$").replace(/"/g,'`"')+'"';case"cmd":return'"'+t.replace(/%/g,"%%").replace(/"/g,'""')+'"';case"bash":case"zsh":case"unknown":default:return"'"+t.replace(/'/g,"'\\''")+"'"}}function B(t){let e=x.window.activeTerminal;if(!e){x.window.showErrorMessage("Terminal Image Paste: No active terminal. Please open a terminal first.");return}let r=Q(e),o=Te(t,r),s=x.workspace.getConfiguration("terminalImgPaste").get("sendNewline",!1);e.sendText(o,s),i.info(`Inserted path into terminal (${r}): ${o}`)}var A=class{_queue=[];_locked=!1;acquire(){return new Promise(e=>{let r=()=>{this._locked?this._queue.push(r):(this._locked=!0,e(()=>{this._locked=!1;let o=this._queue.shift();o&&o()}))};r()})}};function Z(t,e){let r=e instanceof Error?e.message:String(e);d.window.showErrorMessage(`Terminal Image Paste: ${r}`),i.error(`${t} command failed`,e)}function Ee(t){let e=D(),r=Y(e),o=X();r.isToolAvailable().then(n=>{n||d.window.showWarningMessage(`Terminal Image Paste: clipboard tool "${r.requiredTool()}" not found. Install it to use clipboard image pasting.`)}).catch(n=>{i.error("Failed to check tool availability",n)});let a=new A,s=d.commands.registerCommand("terminalImgPaste.pasteImage",async()=>{let n=await a.acquire();try{if(!await r.isToolAvailable()){d.window.showWarningMessage(`Terminal Image Paste: "${r.requiredTool()}" is not installed. Please install it to paste clipboard images.`);return}if(!await r.hasImage()){d.window.showInformationMessage("No image found in clipboard.");return}let{data:ee,format:te}=await r.readImage(),re=await o.save(ee,te);B(re),d.window.setStatusBarMessage("Image pasted to terminal",3e3)}catch(l){Z("pasteImage",l)}finally{n()}}),m=d.commands.registerCommand("terminalImgPaste.sendPathToTerminal",async n=>{try{if(!n?.fsPath){d.window.showErrorMessage("Terminal Image Paste: No file selected.");return}B(n.fsPath),d.window.setStatusBarMessage("Path sent to terminal",3e3)}catch(l){Z("sendPathToTerminal",l)}});t.subscriptions.push(s,m),i.info(`Extension activated (platform: ${e.os}, WSL: ${e.isWSL})`)}function Fe(){i.info("Extension deactivating")}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
