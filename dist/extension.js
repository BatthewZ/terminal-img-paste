"use strict";var at=Object.create;var U=Object.defineProperty;var nt=Object.getOwnPropertyDescriptor;var st=Object.getOwnPropertyNames;var it=Object.getPrototypeOf,lt=Object.prototype.hasOwnProperty;var ct=(e,t)=>{for(var r in t)U(e,r,{get:t[r],enumerable:!0})},ye=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of st(t))!lt.call(e,a)&&a!==r&&U(e,a,{get:()=>t[a],enumerable:!(o=nt(t,a))||o.enumerable});return e};var p=(e,t,r)=>(r=e!=null?at(it(e)):{},ye(t||!e||!e.__esModule?U(r,"default",{value:e,enumerable:!0}):r,e)),mt=e=>ye(U({},"__esModule",{value:!0}),e);var Qt={};ct(Qt,{activate:()=>Xt,deactivate:()=>Jt});module.exports=mt(Qt);var C=p(require("vscode"));var D=p(require("fs")),Se=require("child_process"),Y=null;function dt(){switch(process.platform){case"darwin":return"macos";case"win32":return"windows";default:return"linux"}}function pt(){try{return D.readFileSync("/proc/version","utf-8")}catch{return null}}function Ie(e){return e?/microsoft/i.test(e):!1}function ft(e){return!e||!Ie(e)?null:/microsoft-standard-WSL2/i.test(e)?2:1}function ut(){return D.existsSync("/mnt/wslg/")}function gt(e,t){if(e!=="linux")return"unknown";if(t)return process.env.WAYLAND_DISPLAY?"wayland":process.env.DISPLAY?"x11":"unknown";let r=process.env.XDG_SESSION_TYPE;return r==="wayland"?"wayland":r==="x11"?"x11":process.env.WAYLAND_DISPLAY?"wayland":"unknown"}function xe(e){try{return(0,Se.execFileSync)("command",["-v",e],{encoding:"utf-8",timeout:5e3,shell:!0}).trim()||null}catch{return null}}function ht(e,t){if(e==="windows")return"powershell.exe";if(t){let r=["/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe","/mnt/c/Program Files/PowerShell/7/pwsh.exe"];for(let a of r)if(D.existsSync(a))return a;let o=xe("powershell.exe")??xe("pwsh.exe");return o||"powershell.exe"}return null}function Fe(){if(Y)return Y;let e=dt(),t=e==="linux"?pt():null,r=e==="linux"?Ie(t):!1,o=r?ft(t):null,a=r?ut():!1,n=gt(e,r),s=ht(e,r);return Y={os:e,isWSL:r,wslVersion:o,hasWslg:a,displayServer:n,powershellPath:s},Y}var Ce=p(require("vscode"));function V(){let e=Ce.env.remoteName;return e?{remote:!0,type:e}:{remote:!1}}var B=require("child_process"),me=1e4,wt=10*1024*1024,Te=50*1024*1024;function de(e){return"code"in e&&typeof e.code=="number"?e.code:e.code??"unknown"}function d(e,t,r){return new Promise((o,a)=>{(0,B.execFile)(e,t,{encoding:"utf-8",timeout:r?.timeout??me,maxBuffer:r?.maxBuffer??wt,cwd:r?.cwd},(n,s,i)=>{if(n){a(new Error(`Command "${e}" failed (exit code ${de(n)}): ${i||n.message}`));return}o({stdout:s,stderr:i})})})}function P(e,t,r){return r?.input?vt(e,t,r):new Promise((o,a)=>{(0,B.execFile)(e,t,{encoding:"buffer",timeout:r?.timeout??me,maxBuffer:r?.maxBuffer??Te,cwd:r?.cwd},(n,s,i)=>{let m=i instanceof Buffer?i.toString("utf-8"):String(i);if(n){a(new Error(`Command "${e}" failed (exit code ${de(n)}): ${m||n.message}`));return}o({stdout:s,stderr:m})})})}function vt(e,t,r){let o=r.timeout??me,a=r.maxBuffer??Te;return new Promise((n,s)=>{let i=(0,B.spawn)(e,t,{stdio:["pipe","pipe","pipe"],cwd:r.cwd}),m=[],c=[],f=0,w=0,v=!1,T=setTimeout(()=>{v||(v=!0,i.kill("SIGTERM"),s(new Error(`Command "${e}" failed (exit code ETIMEDOUT): timed out after ${o}ms`)))},o);i.stdout.on("data",u=>{if(f+=u.length,f>a){v||(v=!0,clearTimeout(T),i.kill("SIGTERM"),s(new Error(`Command "${e}" failed (exit code ERR_CHILD_PROCESS_STDIO_MAXBUFFER): stdout maxBuffer length exceeded`)));return}m.push(u)}),i.stderr.on("data",u=>{w+=u.length,w<=a&&c.push(u)}),i.on("error",u=>{v||(v=!0,clearTimeout(T),s(new Error(`Command "${e}" failed (exit code ${de(u)}): ${u.message}`)))}),i.on("close",u=>{if(v)return;v=!0,clearTimeout(T);let x=Buffer.concat(c).toString("utf-8");if(u!==0){s(new Error(`Command "${e}" failed (exit code ${u??"unknown"}): ${x||`process exited with code ${u}`}`));return}n({stdout:Buffer.concat(m),stderr:x})}),i.stdin.on("error",()=>{}),i.stdin.end(r.input)})}var Re=require("child_process");var Ee=p(require("vscode"));function pe(){let e=new Date,t=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0"),o=String(e.getSeconds()).padStart(2,"0"),a=String(e.getMilliseconds()).padStart(3,"0");return`[${t}:${r}:${o}.${a}]`}function Pt(e){let t=Ee.window.createOutputChannel(e);return{info(r){t.appendLine(`${pe()} [INFO] ${r}`)},warn(r,o){let a=`${pe()} [WARN] ${r}`;o!==void 0&&(o instanceof Error&&o.stack?a+=`
${o.stack}`:a+=`
${String(o)}`),t.appendLine(a)},error(r,o){let a=`${pe()} [ERROR] ${r}`;o!==void 0&&(o instanceof Error&&o.stack?a+=`
${o.stack}`:a+=`
${String(o)}`),t.appendLine(a)},show(){t.show()}}}var l=Pt("Terminal Image Paste");var $e=new Map,bt=process.platform==="win32";async function yt(e){let t=$e.get(e);if(t!==void 0)return t;let r=bt?"where":"which";try{let o=await new Promise((a,n)=>{(0,Re.execFile)(r,[e],{timeout:5e3},(s,i)=>{if(s){n(s);return}let m=i.trim().split(/\r?\n/)[0];a(m)})});return $e.set(e,o),o}catch{l.warn(`Could not resolve absolute path for "${e}" \u2014 using bare name`);return}}async function k(e){return await yt(e)??e}async function L(){let{stdout:e}=await d("osascript",["-e","clipboard info"]);return e}function O(e){let t=[];return e.includes("\xABclass PNGf\xBB")&&t.push("png"),(e.includes("\xABclass JPEG\xBB")||e.includes("\xABclass JPEf\xBB"))&&t.push("jpeg"),e.includes("\xABclass TIFF\xBB")&&t.push("tiff"),(e.includes("\xABclass BMP \xBB")||e.includes("\xABclass BMPf\xBB"))&&t.push("bmp"),t}var H=class{resolvedPngpastePath;async getPngpastePath(){return this.resolvedPngpastePath===void 0&&(this.resolvedPngpastePath=await k("pngpaste")),this.resolvedPngpastePath}requiredTool(){return"pngpaste"}async isToolAvailable(){try{return await d("which",["pngpaste"]),!0}catch{return!1}}async hasImage(){try{let t=await L();return O(t).length>0}catch{return!1}}async detectFormat(){let t=await L(),r=O(t);if(r.length>0)return r[0];throw new Error("No image found in clipboard")}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let r=await this.getPngpastePath(),{stdout:o}=await P(r,["-"]);return{data:o,format:"png"}}};var ke={png:"PNGf",jpeg:"JPEG",tiff:"TIFF"},X=class{requiredTool(){return"osascript (built-in)"}async isToolAvailable(){return process.platform==="darwin"}async hasImage(){try{let t=await L();return O(t).length>0}catch{return!1}}async detectFormat(){let t=await L(),r=O(t);if(r.length>0)return r[0];throw new Error("No image found in clipboard")}async readImage(){let t=await this.detectFormat(),r=t in ke,o=r?ke[t]:"PNGf",a=r?t:"png",{stdout:n}=await P("osascript",["-e",`set imgData to (the clipboard as \xABclass ${o}\xBB)`,"-e","return imgData"]);return{data:n,format:a}}};var Ae=[["image/png","png"],["image/jpeg","jpeg"],["image/webp","webp"],["image/tiff","tiff"],["image/bmp","bmp"],["image/x-bmp","bmp"]];function xt(e){for(let[t,r]of Ae)if(e.includes(t))return r;return/^image\//m.test(e)?"unknown":null}function St(e){for(let[t,r]of Ae)if(e.includes(t))return{mime:t,format:r};return/^image\//m.test(e)?{mime:"image/png",format:"unknown"}:null}var $=class{displayServer;resolvedToolPath;constructor(t){this.displayServer=t}isWayland(){return this.displayServer==="wayland"}toolName(){return this.isWayland()?"wl-paste":"xclip"}async getToolPath(){return this.resolvedToolPath===void 0&&(this.resolvedToolPath=await k(this.toolName())),this.resolvedToolPath}requiredTool(){return this.isWayland()?"wl-clipboard (wl-paste)":"xclip"}async isToolAvailable(){try{return this.isWayland()?await d("which",["wl-paste"]):await d("which",["xclip"]),!0}catch{return!1}}async getClipboardTypes(){let t=await this.getToolPath();if(this.isWayland()){let{stdout:r}=await d(t,["--list-types"]);return r}else{let{stdout:r}=await d(t,["-selection","clipboard","-t","TARGETS","-o"]);return r}}async hasImage(){try{let t=await this.getClipboardTypes();return/^image\//m.test(t)}catch{return!1}}async detectFormat(){let t=await this.getClipboardTypes(),r=xt(t);if(r!==null)return r;throw new Error("No image found in clipboard")}async readImage(){let t=await this.getClipboardTypes(),r=St(t);if(!r)throw new Error("No image found in clipboard");let{mime:o,format:a}=r,n=a==="unknown"?"png":a,s=await this.getToolPath(),{stdout:i}=this.isWayland()?await P(s,["--type",o]):await P(s,["-selection","clipboard","-t",o,"-o"]);return{data:i,format:n}}};var fe=p(require("fs"));function I(e){return Buffer.from(e,"utf16le").toString("base64")}var It="Add-Type -AssemblyName System.Windows.Forms; if ([System.Windows.Forms.Clipboard]::ContainsImage()) { echo 'yes' } else { echo 'no' }",Ft="Add-Type -AssemblyName System.Windows.Forms; $img = [System.Windows.Forms.Clipboard]::GetImage(); if ($img -eq $null) { exit 1 }; $tmp = [System.IO.Path]::GetTempFileName(); $img.Save($tmp, [System.Drawing.Imaging.ImageFormat]::Png); Write-Output $tmp",A=class{async isToolAvailable(){try{return await d(this.powershellExe,["-Command","echo ok"]),!0}catch{return!1}}async hasImage(){try{return(await d(this.powershellExe,["-EncodedCommand",I(It)])).stdout.trim()==="yes"}catch{return!1}}async detectFormat(){if(!await this.hasImage())throw new Error("No image found in clipboard");return"png"}async readImage(){let t;try{t=(await d(this.powershellExe,["-EncodedCommand",I(Ft)])).stdout.trim()}catch(o){throw new Error(`PowerShell execution failed: ${o instanceof Error?o.message:o}`)}let r=await this.resolveTempPath(t);try{return{data:await fe.promises.readFile(r),format:"png"}}catch(o){throw new Error(`Temp file read failed: could not read "${r}": ${o instanceof Error?o.message:o}`)}finally{fe.promises.unlink(r).catch(o=>{l.warn(`Failed to clean up temp file: ${r}`,o)})}}};var J=class extends A{resolvedPsPath;get powershellExe(){return this.resolvedPsPath??"powershell.exe"}async resolvePs(){this.resolvedPsPath===void 0&&(this.resolvedPsPath=await k("powershell.exe"))}requiredTool(){return"PowerShell (built-in)"}async isToolAvailable(){return await this.resolvePs(),super.isToolAvailable()}async resolveTempPath(t){return t}};var M=class extends A{psPath;constructor(t){super(),this.psPath=t.powershellPath??"powershell.exe"}get powershellExe(){return this.psPath}requiredTool(){return"PowerShell (via WSL interop)"}async resolveTempPath(t){try{return(await d("wslpath",["-u",t])).stdout.trim()}catch(r){throw new Error(`wslpath conversion failed: could not convert "${t}" to a WSL path: ${r instanceof Error?r.message:r}`)}}};var b=class{readers;constructor(t){if(t.length===0)throw new Error("FallbackClipboardReader requires at least one reader");this.readers=t}getReaders(){return this.readers}requiredTool(){return this.readers.map(t=>t.requiredTool()).join(" or ")}async isToolAvailable(){for(let t of this.readers)if(await t.isToolAvailable())return!0;return!1}async hasImage(){for(let t of this.readers)try{if(await t.hasImage())return!0}catch(r){l.warn(`Clipboard reader ${t.requiredTool()} failed hasImage()`,r)}return!1}async detectFormat(){let t=[];for(let r of this.readers)try{return await r.detectFormat()}catch(o){t.push(o instanceof Error?o:new Error(String(o)))}throw new AggregateError(t,`All clipboard readers failed to detect format: ${t.map(r=>r.message).join("; ")}`)}async readImage(){let t=[];for(let r of this.readers)try{return await r.readImage()}catch(o){t.push(o instanceof Error?o:new Error(String(o)))}throw new AggregateError(t,`All clipboard readers failed: ${t.map(r=>r.message).join("; ")}`)}};var Ne=p(require("fs")),We=p(require("path"));var Ct={".png":"png",".jpg":"jpeg",".jpeg":"jpeg",".bmp":"bmp",".webp":"webp",".tiff":"tiff",".tif":"tiff",".gif":"gif"};function Tt(e){let t=new URL(e);return decodeURIComponent(t.pathname)}var N=class{findFirstImageFile(t){for(let r of t){let o=We.extname(r).toLowerCase(),a=Ct[o];if(a)return{filePath:r,format:a}}return null}async hasImage(){try{let t=await this.getFilePaths();return this.findFirstImageFile(t)!==null}catch{return!1}}async detectFormat(){let t=await this.getFilePaths(),r=this.findFirstImageFile(t);if(r)return r.format;throw new Error("No image file path found in clipboard")}async readImage(){let t=await this.getFilePaths(),r=this.findFirstImageFile(t);if(!r)throw new Error("No image file path found in clipboard");return{data:await Ne.promises.readFile(r.filePath),format:r.format}}},W=class extends N{displayServer;constructor(t){super(),this.displayServer=t}isWayland(){return this.displayServer==="wayland"}requiredTool(){return this.isWayland()?"wl-clipboard (wl-paste) [file paths]":"xclip [file paths]"}async isToolAvailable(){try{let t=this.isWayland()?"wl-paste":"xclip";return await d("which",[t]),!0}catch{return!1}}async getFilePaths(){let{stdout:t}=this.isWayland()?await d("wl-paste",["--type","text/uri-list"]):await d("xclip",["-selection","clipboard","-t","text/uri-list","-o"]);return t.split(`
`).map(r=>r.trim()).filter(r=>r.startsWith("file://")).map(Tt)}},De="Add-Type -AssemblyName System.Windows.Forms; $files = [System.Windows.Forms.Clipboard]::GetFileDropList(); foreach ($f in $files) { Write-Output $f }",Q=class extends N{requiredTool(){return"PowerShell (built-in) [file paths]"}async isToolAvailable(){try{return await d("powershell.exe",["-Command","echo ok"]),!0}catch{return!1}}async getFilePaths(){let{stdout:t}=await d("powershell.exe",["-EncodedCommand",I(De)]);return t.split(`
`).map(r=>r.trim()).filter(r=>r.length>0)}},_=class extends N{psPath;constructor(t){super(),this.psPath=t.powershellPath??"powershell.exe"}requiredTool(){return"PowerShell (via WSL interop) [file paths]"}async isToolAvailable(){try{return await d(this.psPath,["-Command","echo ok"]),!0}catch{return!1}}async getFilePaths(){let{stdout:t}=await d(this.psPath,["-EncodedCommand",I(De)]),r=t.split(`
`).map(a=>a.trim()).filter(a=>a.length>0),o=[];for(let a of r)try{let{stdout:n}=await d("wslpath",["-u",a]);o.push(n.trim())}catch(n){l.warn(`wslpath conversion failed for "${a}":`,n)}return o}},K=class extends N{requiredTool(){return"osascript (built-in) [file paths]"}async isToolAvailable(){return process.platform==="darwin"}async getFilePaths(){let{stdout:t}=await d("osascript",["-e","try","-e","  set fileList to (the clipboard as \xABclass furl\xBB)","-e","  return POSIX path of fileList","-e","on error","-e",'  return ""',"-e","end try"]),r=t.trim();return r?[r]:[]}};function Be(e){if(e.isWSL){let t=e.displayServer==="x11"||e.displayServer==="wayland";if(e.hasWslg&&t)return new b([new $(e.displayServer),new M(e),new W(e.displayServer),new _(e)]);let r=[new M(e)];return t&&r.push(new $(e.displayServer)),r.push(new _(e)),t&&r.push(new W(e.displayServer)),new b(r)}switch(e.os){case"macos":return new b([new H,new X,new K]);case"windows":return new b([new J,new Q]);case"linux":{let t=new $(e.displayServer),r=e.displayServer==="wayland"?"x11":"wayland",o=new $(r);return new b([t,o,new W(e.displayServer)])}}}var Ge=p(require("crypto")),g=p(require("fs")),h=p(require("path")),ve=p(require("vscode"));var ue=p(require("fs")),Oe=p(require("path")),Le=100;async function Z(e,t){try{return await ue.promises.writeFile(e,t,{flag:"wx",mode:384}),e}catch(a){if(a.code!=="EEXIST")throw a}let r=Oe.extname(e),o=e.slice(0,e.length-r.length);for(let a=1;a<=Le;a++){let n=`${o}-${a}${r}`;try{return await ue.promises.writeFile(n,t,{flag:"wx",mode:384}),n}catch(s){if(s.code!=="EEXIST")throw s}}throw new Error(`Unable to write file after ${Le} retries: ${e}`)}var Et=".tip-images",qe=[".png",".jpg",".jpeg",".tiff",".tif",".bmp",".webp",".gif"];function $t(e){switch(e){case"jpeg":return".jpg";case"tiff":return".tiff";case"bmp":return".bmp";case"webp":return".webp";case"gif":return".gif";case"png":case"unknown":default:return".png"}}var ge=Buffer.from([137,80,78,71,13,10,26,10]);function Rt(e,t){switch(t){case"png":if(e.length<ge.length||!e.subarray(0,ge.length).equals(ge))throw new Error("Clipboard data is not a valid PNG image");break;case"jpeg":if(e.length<2||e[0]!==255||e[1]!==216)throw new Error("Clipboard data is not a valid JPEG image");break;case"bmp":if(e.length<2||e[0]!==66||e[1]!==77)throw new Error("Clipboard data is not a valid BMP image");break;case"webp":if(e.length<12||e.subarray(0,4).toString("ascii")!=="RIFF"||e.subarray(8,12).toString("ascii")!=="WEBP")throw new Error("Clipboard data is not a valid WebP image");break;case"tiff":if(e.length<2||!(e[0]===73&&e[1]===73||e[0]===77&&e[1]===77))throw new Error("Clipboard data is not a valid TIFF image");break;case"gif":if(e.length<3||e.subarray(0,3).toString("ascii")!=="GIF")throw new Error("Clipboard data is not a valid GIF image");break;case"unknown":l.warn("Skipping image validation for unknown format");break}}function j(){return ve.workspace.getConfiguration("terminalImgPaste")}function we(){let e=ve.workspace.workspaceFolders;if(!e||e.length===0)throw new Error("No workspace folder is open. Please open a folder first.");return e[0].uri.fsPath}function ze(){return j().get("folderName",Et)}function Me(){let e=we(),t=ze(),r=h.resolve(e,t);if(!r.startsWith(e+h.sep))throw new Error(`Configured folderName "${t}" must resolve to a subdirectory of the workspace root`);return r}var Ue="img-{timestamp}",_e=["{timestamp}","{n}","{hash}"];function kt(e,t,r){e||(e=Ue);let o=new Date;if(e.includes("{"))_e.some(s=>e.includes(s))||l.warn(`Filename pattern "${e}" lacks a uniqueness placeholder (${_e.join(", ")}). Filenames may collide.`);else{let s=je(o);e=`${e}-${s}`}let n=e;if(n=n.replace(/\{timestamp\}/g,je(o)),n=n.replace(/\{date\}/g,ee(o)),n=n.replace(/\{time\}/g,Ye(o)),n.includes("{hash}")){let s=Ge.createHash("sha256").update(t).digest("hex").slice(0,8);n=n.replace(/\{hash\}/g,s)}return n.includes("{n}")&&(n=At(n,r)),n}function je(e){let t=String(e.getMilliseconds()).padStart(3,"0");return`${ee(e)}T${Ye(e)}-${t}`}function ee(e){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${o}`}function Ye(e){let t=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0"),o=String(e.getSeconds()).padStart(2,"0");return`${t}-${r}-${o}`}function At(e,t){let r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/\\{n\\}/g,"(\\d+)"),o=new RegExp(`^${r}`),a=0;for(let n of t){let i=n.replace(/\.[^.]+$/,"").match(o);if(i&&i[1]){let m=parseInt(i[1],10);m>a&&(a=m)}}return e.replace(/\{n\}/g,String(a+1))}function Nt(e,t,r){let o=j().get("filenamePattern",Ue),a=kt(o,t,r),n=$t(e);return`${a}${n}`}async function he(e,t){let r=await g.promises.realpath(e),o=await g.promises.realpath(t),a=process.platform==="win32"||process.platform==="darwin",n=a?r.toLowerCase():r,s=a?o.toLowerCase():o;if(n!==s&&!n.startsWith(s+h.sep))throw new Error(`Image folder resolves to a path outside the workspace (possible symlink escape): ${r}`);return r}function Wt(e,t=new Date){switch(e){case"daily":return ee(t);case"monthly":return ee(t).substring(0,7);case"flat":default:return""}}async function te(e){let t=[],r;try{r=await g.promises.readdir(e,{withFileTypes:!0})}catch{return t}for(let o of r){let a=h.join(e,o.name);o.isDirectory()&&!o.isSymbolicLink()?t.push(...await te(a)):!o.isSymbolicLink()&&qe.some(n=>o.name.endsWith(n))&&t.push({filePath:a,name:o.name})}return t}async function Dt(e,t){if(e!==t)try{(await g.promises.readdir(e)).length===0&&(await g.promises.rmdir(e),l.info(`Removed empty directory: ${e}`))}catch(r){l.warn(`Failed to remove empty directory ${e}:`,r)}}function Ve(){return{async save(e,t="png"){if(e.length===0)throw new Error("Cannot save empty image data");Rt(e,t);let r=Me(),o=we();await g.promises.mkdir(r,{recursive:!0}),await he(r,o);let a=j().get("organizeFolders","flat"),n=Wt(a),s=n?h.join(r,n):r;n&&(await g.promises.mkdir(s,{recursive:!0}),await he(s,o));let i;try{i=await g.promises.readdir(s)}catch{i=[]}let m=Nt(t,e,i),c=h.join(s,m),f=await Z(c,e);return await he(f,o),l.info(`Saved image: ${f}`),await this.cleanup(),await this.ensureGitIgnored(),f},async cleanup(){let e=j(),t=e.get("maxImages",20),r=Number.isInteger(t)&&t>0?t:20,o=e.get("organizeFolders","flat"),a=Me();if(o==="flat"){let n;try{n=await g.promises.readdir(a)}catch{return}let s=n.filter(m=>qe.some(c=>m.endsWith(c))).sort();if(s.length<=r)return;let i=s.slice(0,s.length-r);for(let m of i){let c=h.join(a,m);try{await g.promises.unlink(c),l.info(`Deleted old image: ${c}`)}catch(f){l.warn(`Failed to delete old image: ${c}`,f)}}}else{let n=await te(a);if(n.sort((m,c)=>m.name.localeCompare(c.name)),n.length<=r)return;let s=n.slice(0,n.length-r),i=new Set;for(let m of s)try{await g.promises.unlink(m.filePath),l.info(`Deleted old image: ${m.filePath}`),i.add(h.dirname(m.filePath))}catch(c){l.warn(`Failed to delete old image: ${m.filePath}`,c)}for(let m of i)await Dt(m,a)}},async ensureGitIgnored(){if(!j().get("autoGitIgnore",!0))return;let t=ze(),r=we(),o=h.join(r,".gitignore"),a;try{a=await g.promises.readFile(o,"utf-8")}catch{await g.promises.writeFile(o,t+`
`,"utf-8"),l.info(`Created .gitignore with ${t}`);return}if(a.split(`
`).map(i=>i.trim()).includes(t))return;let s=a.endsWith(`
`)?"":`
`;await g.promises.writeFile(o,a+s+t+`
`,"utf-8"),l.info(`Added ${t} to .gitignore`)}}}var G=p(require("vscode"));var Xe=p(require("path")),Bt=[{pattern:/\bbash\b/i,type:"bash"},{pattern:/\bzsh\b/i,type:"zsh"},{pattern:/\bfish\b/i,type:"fish"},{pattern:/\b(?:pwsh|powershell)\b/i,type:"powershell"},{pattern:/\bcmd\b/i,type:"cmd"}];function He(e){let t=Xe.basename(e).replace(/\.exe$/i,"");for(let{pattern:r,type:o}of Bt)if(r.test(t))return o;return"unknown"}function re(e){let t=e.creationOptions?.shellPath;if(t)return He(t);let r=process.env.SHELL;return r?He(r):process.platform==="win32"?"powershell":"unknown"}function Lt(e,t){switch(t){case"fish":return"'"+e.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'";case"powershell":return'"'+e.replace(/`/g,"``").replace(/\$/g,"`$").replace(/"/g,'`"')+'"';case"cmd":return'"'+e.replace(/%/g,"%%").replace(/"/g,'""')+'"';case"bash":case"zsh":case"unknown":default:return"'"+e.replace(/'/g,"'\\''")+"'"}}function q(e){let t=G.window.activeTerminal;if(!t){G.window.showErrorMessage("Terminal Image Paste: No active terminal. Please open a terminal first.");return}let r=re(t),o=Lt(e,r),n=G.workspace.getConfiguration("terminalImgPaste").get("sendNewline",!1);t.sendText(o,n),l.info(`Inserted path into terminal (${r}): ${o}`)}var oe=p(require("fs")),Je=p(require("os")),Pe=p(require("path"));async function ae(e,t,r,o){if(r==="auto"||t===r)return{data:e,format:t};try{return{data:await Mt(e,t,r,o),format:r}}catch(a){return l.warn(`Image conversion from ${t} to ${r} failed, saving in native format: ${a instanceof Error?a.message:String(a)}`),{data:e,format:t}}}async function Ot(e){if(e.os==="macos")return"sips";if(e.os==="windows"||e.isWSL)return e.powershellPath?"powershell":null;try{return await d("which",["convert"]),"magick"}catch{}try{return await d("which",["ffmpeg"]),"ffmpeg"}catch{}return null}async function Mt(e,t,r,o){let a=await Ot(o);if(a===null)throw new Error("No conversion tool available");switch(a){case"sips":return _t(e,r);case"magick":return jt(e,t,r);case"ffmpeg":return Gt(e,r);case"powershell":return qt(e,r,o.powershellPath)}}async function _t(e,t){let r=Je.tmpdir(),o=Pe.join(r,`tip-convert-in-${Date.now()}`),a=t==="jpeg"?"jpg":"png",n=Pe.join(r,`tip-convert-out-${Date.now()}.${a}`),s=await Z(o,e);try{return await d("sips",["--setProperty","format",t==="jpeg"?"jpeg":"png",s,"--out",n]),await oe.promises.readFile(n)}finally{await oe.promises.unlink(s).catch(()=>{}),await oe.promises.unlink(n).catch(()=>{})}}async function jt(e,t,r){let o=t==="unknown"?"-":`${t}:-`,a=`${r}:-`;return(await P("convert",[o,a],{input:e})).stdout}async function Gt(e,t){return(await P("ffmpeg",["-hide_banner","-loglevel","error","-f","image2pipe","-i","-","-f","image2","-c:v",t==="png"?"png":"mjpeg","-"],{input:e})).stdout}async function qt(e,t,r){return(await P(r,["-NoProfile","-EncodedCommand",I(`
Add-Type -AssemblyName System.Drawing
$stdin = [Console]::OpenStandardInput()
$ms = New-Object System.IO.MemoryStream
$stdin.CopyTo($ms)
$ms.Position = 0
$img = [System.Drawing.Image]::FromStream($ms)
$outMs = New-Object System.IO.MemoryStream
$img.Save($outMs, [System.Drawing.Imaging.ImageFormat]::${t==="png"?"Png":"Jpeg"})
[Console]::OpenStandardOutput().Write($outMs.ToArray(), 0, $outMs.Length)
$img.Dispose()
$ms.Dispose()
$outMs.Dispose()
`)],{input:e})).stdout}var ne=p(require("vscode")),Qe=1e4;function Ke(e,t){return new Promise(r=>{let o=!1,a,n=c=>{o||(o=!0,clearTimeout(a),s.dispose(),r(c))},s=ne.window.createWebviewPanel("terminalImgPaste.preview","Image Preview \u2014 Terminal Image Paste",ne.ViewColumn.Active,{enableScripts:!0}),i=t==="unknown"?"image/png":`image/${t}`,m=e.toString("base64");s.webview.html=zt(i,m,Qe),s.webview.onDidReceiveMessage(c=>{c.command==="paste"?n(!0):(c.command==="cancel"||c.command==="timeout")&&n(!1)}),s.onDidDispose(()=>{n(!1)}),a=setTimeout(()=>{n(!1)},Qe+500)})}function zt(e,t,r){let o=Math.round(r/1e3);return`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; img-src data:; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Preview</title>
  <style>
    body { font-family: var(--vscode-font-family, sans-serif); padding: 16px; text-align: center; color: var(--vscode-foreground); background: var(--vscode-editor-background); }
    img { max-width: 100%; max-height: 60vh; border: 1px solid var(--vscode-panel-border, #444); margin-bottom: 12px; }
    .info { margin-bottom: 16px; opacity: 0.8; font-size: 13px; }
    .buttons { display: flex; justify-content: center; gap: 12px; }
    button { padding: 8px 20px; font-size: 14px; cursor: pointer; border: none; border-radius: 4px; }
    .btn-paste { background: var(--vscode-button-background, #0078d4); color: var(--vscode-button-foreground, #fff); }
    .btn-paste:hover { background: var(--vscode-button-hoverBackground, #005a9e); }
    .btn-cancel { background: var(--vscode-button-secondaryBackground, #333); color: var(--vscode-button-secondaryForeground, #fff); }
    .btn-cancel:hover { background: var(--vscode-button-secondaryHoverBackground, #444); }
    .countdown { margin-top: 12px; font-size: 12px; opacity: 0.6; }
  </style>
</head>
<body>
  <img id="preview" src="data:${e};base64,${t}" alt="Clipboard image preview"
       onload="document.getElementById('dims').textContent = this.naturalWidth + ' \xD7 ' + this.naturalHeight + ' px';" />
  <div class="info" id="dims"></div>
  <div class="buttons">
    <button class="btn-paste" id="pasteBtn">Paste</button>
    <button class="btn-cancel" id="cancelBtn">Cancel</button>
  </div>
  <div class="countdown" id="timer">Auto-cancel in ${o}s</div>
  <script>
    const vscode = acquireVsCodeApi();
    document.getElementById('pasteBtn').addEventListener('click', () => vscode.postMessage({ command: 'paste' }));
    document.getElementById('cancelBtn').addEventListener('click', () => vscode.postMessage({ command: 'cancel' }));

    let remaining = ${o};
    const timerEl = document.getElementById('timer');
    const interval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(interval);
        timerEl.textContent = 'Auto-cancelled';
        vscode.postMessage({ command: 'timeout' });
      } else {
        timerEl.textContent = 'Auto-cancel in ' + remaining + 's';
      }
    }, 1000);
  </script>
</body>
</html>`}var R=p(require("vscode"));function se(){return R.workspace.getConfiguration("terminalImgPaste").get("notifications","all")}function Ut(){return{statusBar(e,t=3e3){l.info(e),se()==="all"&&R.window.setStatusBarMessage(e,t)},info(e){l.info(e),se()==="all"&&R.window.showInformationMessage(e)},async warning(e,...t){return l.warn(e),se()==="all"?R.window.showWarningMessage(e,...t):t.length>0?t[0]:void 0},error(e){l.error(e);let t=se();(t==="all"||t==="errors")&&R.window.showErrorMessage(e)}}}var y=Ut();var ie=class{_queue=[];_locked=!1;acquire(){return new Promise(t=>{let r=()=>{this._locked?this._queue.push(r):(this._locked=!0,t(()=>{this._locked=!1;let o=this._queue.shift();o&&o()}))};r()})}};var Ze=p(require("path")),F=p(require("vscode"));async function Yt(e){return(await te(e)).length}async function Vt(e,t){let r=F.workspace.getConfiguration("terminalImgPaste"),o={os:e.os,isWsl:e.isWSL,wslVersion:e.isWSL?`WSL${e.wslVersion??"?"}`:"N/A",hasWslg:e.isWSL?e.hasWslg?"Yes":"No":"N/A",displayServer:e.displayServer,powershellPath:e.powershellPath??"N/A"},a=t instanceof b?[...t.getReaders()]:[t],n=[];for(let E of a){let z=E.constructor.name;try{let S=await E.isToolAvailable();n.push({name:z,available:S?"Yes":"No"})}catch(S){n.push({name:z,available:`Error: ${S instanceof Error?S.message:String(S)}`})}}let s="N/A";try{s=await t.detectFormat()}catch(E){s=`Error: ${E instanceof Error?E.message:String(E)}`}let i=F.workspace.workspaceFolders,m=i?.[0]?.uri.fsPath??"None",c=r.get("folderName",".tip-images"),f=i?Ze.join(m,c):"N/A",w=r.get("maxImages",20),v=i?await Yt(f):0,T=F.window.activeTerminal,u=T?re(T):"No active terminal",x=V();return{platform:o,clipboard:{readers:n,detectedFormat:s},storage:{workspaceFolder:m,imageFolder:f,imageCount:`${v} / ${w}`,organizeFolders:r.get("organizeFolders","flat"),filenamePattern:r.get("filenamePattern","img-{timestamp}")},settings:{maxImages:w,autoGitIgnore:r.get("autoGitIgnore",!0),sendNewline:r.get("sendNewline",!1),showPreview:r.get("showPreview",!1),notifications:r.get("notifications","all"),saveFormat:r.get("saveFormat","auto"),folderName:c,warnOnRemote:r.get("warnOnRemote",!0)},terminal:{activeShell:u,isRemote:x.remote,remoteName:x.remote?x.type:"N/A"}}}function Ht(e){let t=[];t.push("# Terminal Image Paste \u2014 Diagnostics"),t.push(""),t.push("## Platform"),t.push("| Property | Value |"),t.push("|----------|-------|"),t.push(`| OS | ${e.platform.os} |`),t.push(`| WSL | ${e.platform.isWsl?`Yes (${e.platform.wslVersion})`:"No"} |`),e.platform.isWsl&&t.push(`| WSLg | ${e.platform.hasWslg} |`),t.push(`| Display Server | ${e.platform.displayServer} |`),e.platform.powershellPath!=="N/A"&&t.push(`| PowerShell Path | ${e.platform.powershellPath} |`),t.push(""),t.push("## Clipboard"),t.push("| Reader | Available |"),t.push("|--------|-----------|");for(let r of e.clipboard.readers)t.push(`| ${r.name} | ${r.available} |`);return t.push(`| Detected Format | ${e.clipboard.detectedFormat} |`),t.push(""),t.push("## Storage"),t.push("| Property | Value |"),t.push("|----------|-------|"),t.push(`| Workspace Folder | ${e.storage.workspaceFolder} |`),t.push(`| Image Folder | ${e.storage.imageFolder} |`),t.push(`| Image Count | ${e.storage.imageCount} |`),t.push(`| Organization | ${e.storage.organizeFolders} |`),t.push(`| Filename Pattern | ${e.storage.filenamePattern} |`),t.push(""),t.push("## Settings"),t.push("| Setting | Value |"),t.push("|---------|-------|"),t.push(`| maxImages | ${e.settings.maxImages} |`),t.push(`| autoGitIgnore | ${e.settings.autoGitIgnore} |`),t.push(`| sendNewline | ${e.settings.sendNewline} |`),t.push(`| showPreview | ${e.settings.showPreview} |`),t.push(`| notifications | ${e.settings.notifications} |`),t.push(`| saveFormat | ${e.settings.saveFormat} |`),t.push(`| warnOnRemote | ${e.settings.warnOnRemote} |`),t.push(""),t.push("## Terminal"),t.push("| Property | Value |"),t.push("|----------|-------|"),t.push(`| Active Shell | ${e.terminal.activeShell} |`),t.push(`| Remote | ${e.terminal.isRemote?"Yes":"No"} |`),e.terminal.isRemote&&t.push(`| Remote Name | ${e.terminal.remoteName} |`),t.push(""),t.push("---"),t.push(`*Generated at ${new Date().toISOString()}*`),t.push(""),t.join(`
`)}async function et(e,t){try{let r=await Vt(e,t),o=Ht(r),a=await F.workspace.openTextDocument({content:o,language:"markdown"});await F.window.showTextDocument(a),l.info("Diagnostics report generated")}catch(r){let o=r instanceof Error?r.message:String(r);l.error("Failed to generate diagnostics report",r),F.window.showErrorMessage(`Terminal Image Paste: Failed to generate diagnostics \u2014 ${o}`)}}var le=p(require("vscode")),tt=p(require("path"));function rt(e,t,r,o){return{async pasteFromClipboard(){if(!await t.hasImage())return;let{data:n,format:s}=await t.readImage(),m=le.workspace.getConfiguration("terminalImgPaste").get("saveFormat","auto"),c=await ae(n,s,m,e),w={path:await r.save(c.data,c.format),format:c.format};return o.fire(w),w},sendPathToTerminal(a){q(a)},getImageFolder(){let a=le.workspace.workspaceFolders;if(!a||a.length===0)return;let s=le.workspace.getConfiguration("terminalImgPaste").get("folderName",".tip-images");return tt.resolve(a[0].uri.fsPath,s)},onImagePasted:o.event}}function ot(e,t){let r=t instanceof Error?t.message:String(t);y.error(`Terminal Image Paste: ${r}`),l.error(`${e} command failed`,t)}function Xt(e){let t=Fe(),r=Be(t),o=Ve(),a=new C.EventEmitter;e.subscriptions.push(a),r.isToolAvailable().then(c=>{c||y.warning(`Terminal Image Paste: clipboard tool "${r.requiredTool()}" not found. Install it to use clipboard image pasting.`)}).catch(c=>{l.error("Failed to check tool availability",c)});let n=new ie,s=C.commands.registerCommand("terminalImgPaste.pasteImage",async()=>{let c=await n.acquire();try{if(!await r.isToolAvailable()){y.warning(`Terminal Image Paste: "${r.requiredTool()}" is not installed. Please install it to paste clipboard images.`);return}let w=C.workspace.getConfiguration("terminalImgPaste");if(w.get("warnOnRemote",!0)){let ce=V();if(ce.remote&&ce.type!=="wsl"&&await y.warning("Clipboard images are saved locally. The pasted path may not be accessible from the remote terminal.","Paste Anyway","Cancel")!=="Paste Anyway")return}if(!await r.hasImage()){y.info("No image found in clipboard.");return}let{data:u,format:x}=await r.readImage();if(w.get("showPreview",!1)&&!await Ke(u,x)){y.statusBar("Image paste cancelled",3e3);return}let z=w.get("saveFormat","auto"),S=await ae(u,x,z,t),be=await o.save(S.data,S.format);q(be),a.fire({path:be,format:S.format}),y.statusBar("Image pasted to terminal",3e3)}catch(f){ot("pasteImage",f)}finally{c()}}),i=C.commands.registerCommand("terminalImgPaste.sendPathToTerminal",async c=>{try{if(!c?.fsPath){y.error("Terminal Image Paste: No file selected.");return}q(c.fsPath),y.statusBar("Path sent to terminal",3e3)}catch(f){ot("sendPathToTerminal",f)}}),m=C.commands.registerCommand("terminalImgPaste.showDiagnostics",()=>et(t,r));return e.subscriptions.push(s,i,m),l.info(`Extension activated (platform: ${t.os}, WSL: ${t.isWSL})`),rt(t,r,o,a)}function Jt(){l.info("Extension deactivating")}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
