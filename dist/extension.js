"use strict";var z=Object.create;var y=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,ee=Object.prototype.hasOwnProperty;var re=(r,e)=>{for(var t in e)y(r,t,{get:e[t],enumerable:!0})},_=(r,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Q(e))!ee.call(r,a)&&a!==t&&y(r,a,{get:()=>e[a],enumerable:!(o=K(e,a))||o.enumerable});return r};var f=(r,e,t)=>(t=r!=null?z(Z(r)):{},_(e||!r||!r.__esModule?y(t,"default",{value:r,enumerable:!0}):t,r)),te=r=>_(y({},"__esModule",{value:!0}),r);var Pe={};re(Pe,{activate:()=>he,deactivate:()=>be});module.exports=te(Pe);var d=f(require("vscode"));var I=f(require("fs")),x=null;function oe(){switch(process.platform){case"darwin":return"macos";case"win32":return"windows";default:return"linux"}}function ae(){try{let r=I.readFileSync("/proc/version","utf-8");return/microsoft/i.test(r)}catch{return!1}}function se(r,e){if(r!=="linux")return"unknown";if(e)return process.env.WAYLAND_DISPLAY?"wayland":process.env.DISPLAY?"x11":"unknown";let t=process.env.XDG_SESSION_TYPE;return t==="wayland"?"wayland":t==="x11"?"x11":process.env.WAYLAND_DISPLAY?"wayland":"unknown"}function ie(r,e){if(r==="windows")return"powershell.exe";if(e){let t=["/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe","/mnt/c/Program Files/PowerShell/7/pwsh.exe"];for(let o of t)if(I.existsSync(o))return o;return"powershell.exe"}return null}function D(){if(x)return x;let r=oe(),e=r==="linux"?ae():!1,t=se(r,e),o=ie(r,e);return x={os:r,isWSL:e,displayServer:t,powershellPath:o},x}var $=require("child_process"),L=1e4,ne=10*1024*1024,le=50*1024*1024;function q(r){return"code"in r&&typeof r.code=="number"?r.code:r.code??"unknown"}function n(r,e,t){return new Promise((o,a)=>{(0,$.execFile)(r,e,{encoding:"utf-8",timeout:t?.timeout??L,maxBuffer:t?.maxBuffer??ne,cwd:t?.cwd},(i,c,s)=>{if(i){a(new Error(`Command "${r}" failed (exit code ${q(i)}): ${s||i.message}`));return}o({stdout:c,stderr:s})})})}function g(r,e,t){return new Promise((o,a)=>{(0,$.execFile)(r,e,{encoding:"buffer",timeout:t?.timeout??L,maxBuffer:t?.maxBuffer??le,cwd:t?.cwd},(i,c,s)=>{let m=s instanceof Buffer?s.toString("utf-8"):String(s);if(i){a(new Error(`Command "${r}" failed (exit code ${q(i)}): ${m||i.message}`));return}o({stdout:c,stderr:m})})})}function S(r){let e=[];return r.includes("\xABclass PNGf\xBB")&&e.push("png"),(r.includes("\xABclass JPEG\xBB")||r.includes("\xABclass JPEf\xBB"))&&e.push("jpeg"),r.includes("\xABclass TIFF\xBB")&&e.push("tiff"),(r.includes("\xABclass BMP \xBB")||r.includes("\xABclass BMPf\xBB"))&&e.push("bmp"),e}var E=class{requiredTool(){return"pngpaste"}async isToolAvailable(){try{return await n("which",["pngpaste"]),!0}catch{return!1}}async getClipboardInfo(){let{stdout:e}=await n("osascript",["-e","clipboard info"]);return e}async hasImage(){try{let e=await this.getClipboardInfo();return S(e).length>0}catch{return!1}}async detectFormat(){let e=await this.getClipboardInfo(),t=S(e);if(t.length>0)return t[0];throw new Error("No image found in clipboard")}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let{stdout:t}=await g("pngpaste",["-"]);return t}};var C=class{requiredTool(){return"osascript (built-in)"}async isToolAvailable(){return process.platform==="darwin"}async getClipboardInfo(){let{stdout:e}=await n("osascript",["-e","clipboard info"]);return e}async hasImage(){try{let e=await this.getClipboardInfo();return S(e).length>0}catch{return!1}}async detectFormat(){if(!await this.hasImage())throw new Error("No image found in clipboard");return"png"}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let{stdout:t}=await g("osascript",["-e","set pngData to (the clipboard as \xABclass PNGf\xBB)","-e","return pngData"]);return t}};var ce=[["image/png","png"],["image/jpeg","jpeg"],["image/webp","webp"],["image/tiff","tiff"],["image/bmp","bmp"],["image/x-bmp","bmp"]];function me(r){for(let[e,t]of ce)if(r.includes(e))return t;return/^image\//m.test(r)?"unknown":null}var w=class{displayServer;constructor(e){this.displayServer=e}isWayland(){return this.displayServer==="wayland"}requiredTool(){return this.isWayland()?"wl-clipboard (wl-paste)":"xclip"}async isToolAvailable(){try{return this.isWayland()?await n("which",["wl-paste"]):await n("which",["xclip"]),!0}catch{return!1}}async getClipboardTypes(){if(this.isWayland()){let{stdout:e}=await n("wl-paste",["--list-types"]);return e}else{let{stdout:e}=await n("xclip",["-selection","clipboard","-t","TARGETS","-o"]);return e}}async hasImage(){try{let e=await this.getClipboardTypes();return/^image\//m.test(e)}catch{return!1}}async detectFormat(){let e=await this.getClipboardTypes(),t=me(e);if(t!==null)return t;throw new Error("No image found in clipboard")}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");if(this.isWayland()){let{stdout:t}=await g("wl-paste",["--type","image/png"]);return t}else{let{stdout:t}=await g("xclip",["-selection","clipboard","-t","image/png","-o"]);return t}}};var N=f(require("fs"));var G=f(require("vscode"));function R(){let r=new Date,e=String(r.getHours()).padStart(2,"0"),t=String(r.getMinutes()).padStart(2,"0"),o=String(r.getSeconds()).padStart(2,"0"),a=String(r.getMilliseconds()).padStart(3,"0");return`[${e}:${t}:${o}.${a}]`}function de(r){let e=G.window.createOutputChannel(r);return{info(t){e.appendLine(`${R()} [INFO] ${t}`)},warn(t,o){let a=`${R()} [WARN] ${t}`;o!==void 0&&(o instanceof Error&&o.stack?a+=`
${o.stack}`:a+=`
${String(o)}`),e.appendLine(a)},error(t,o){let a=`${R()} [ERROR] ${t}`;o!==void 0&&(o instanceof Error&&o.stack?a+=`
${o.stack}`:a+=`
${String(o)}`),e.appendLine(a)},show(){e.show()}}}var l=de("Terminal Image Paste");var fe="Add-Type -AssemblyName System.Windows.Forms; if ([System.Windows.Forms.Clipboard]::ContainsImage()) { echo 'yes' } else { echo 'no' }",pe="Add-Type -AssemblyName System.Windows.Forms; $img = [System.Windows.Forms.Clipboard]::GetImage(); if ($img -eq $null) { exit 1 }; $tmp = [System.IO.Path]::GetTempFileName(); $img.Save($tmp, [System.Drawing.Imaging.ImageFormat]::Png); Write-Output $tmp",h=class{async isToolAvailable(){try{return await n(this.powershellExe,["-Command","echo ok"]),!0}catch{return!1}}async hasImage(){try{return(await n(this.powershellExe,["-Command",fe])).stdout.trim()==="yes"}catch{return!1}}async detectFormat(){if(!await this.hasImage())throw new Error("No image found in clipboard");return"png"}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let t=await n(this.powershellExe,["-Command",pe]),o=await this.resolveTempPath(t.stdout.trim());try{return await N.promises.readFile(o)}finally{N.promises.unlink(o).catch(a=>{l.warn(`Failed to clean up temp file: ${o}`,a)})}}};var T=class extends h{get powershellExe(){return"powershell.exe"}requiredTool(){return"PowerShell (built-in)"}async resolveTempPath(e){return e}};var F=class extends h{psPath;constructor(e){super(),this.psPath=e.powershellPath??"powershell.exe"}get powershellExe(){return this.psPath}requiredTool(){return"PowerShell (via WSL interop)"}async resolveTempPath(e){return(await n("wslpath",["-u",e])).stdout.trim()}};var b=class{readers;constructor(e){if(e.length===0)throw new Error("FallbackClipboardReader requires at least one reader");this.readers=e}requiredTool(){return this.readers.map(e=>e.requiredTool()).join(" or ")}async isToolAvailable(){for(let e of this.readers)if(await e.isToolAvailable())return!0;return!1}async hasImage(){for(let e of this.readers)try{if(await e.hasImage())return!0}catch{continue}return!1}async detectFormat(){let e=[];for(let t of this.readers)try{return await t.detectFormat()}catch(o){e.push(o instanceof Error?o:new Error(String(o)))}throw new AggregateError(e,`All clipboard readers failed to detect format: ${e.map(t=>t.message).join("; ")}`)}async readImage(){let e=[];for(let t of this.readers)try{if(!await t.isToolAvailable()){e.push(new Error(`${t.requiredTool()}: tool not available`));continue}return await t.readImage()}catch(o){e.push(o instanceof Error?o:new Error(String(o)))}throw new AggregateError(e,`All clipboard readers failed: ${e.map(t=>t.message).join("; ")}`)}};function O(r){if(r.isWSL){let e=[new F(r)];return(r.displayServer==="x11"||r.displayServer==="wayland")&&e.push(new w(r.displayServer)),e.length===1?e[0]:new b(e)}switch(r.os){case"macos":return new b([new E,new C]);case"windows":return new T;case"linux":{let e=new w(r.displayServer),t=r.displayServer==="wayland"?"x11":"wayland",o=new w(t);return new b([e,o])}}}var p=f(require("fs")),u=f(require("path")),P=f(require("vscode"));var ue=".tip-images",k=Buffer.from([137,80,78,71,13,10,26,10]);function ge(r){if(r.length<k.length||!r.subarray(0,k.length).equals(k))throw new Error("Clipboard data is not a valid PNG image")}function B(){return P.workspace.getConfiguration("terminalImgPaste")}function U(){let r=P.workspace.workspaceFolders;if(!r||r.length===0)throw P.window.showErrorMessage("Terminal Image Paste: No workspace folder is open. Please open a folder first."),new Error("No workspace folder is open");return r[0].uri.fsPath}function Y(){return B().get("folderName",ue)}function j(){let r=U(),e=Y(),t=u.resolve(r,e);if(!t.startsWith(r+u.sep))throw new Error(`Configured folderName "${e}" must resolve to a subdirectory of the workspace root`);return t}function we(){let r=new Date,e=r.getFullYear(),t=String(r.getMonth()+1).padStart(2,"0"),o=String(r.getDate()).padStart(2,"0"),a=String(r.getHours()).padStart(2,"0"),i=String(r.getMinutes()).padStart(2,"0"),c=String(r.getSeconds()).padStart(2,"0"),s=String(r.getMilliseconds()).padStart(3,"0");return`img-${e}-${t}-${o}T${a}-${i}-${c}-${s}.png`}function H(){return{async save(r){ge(r);let e=j();await p.promises.mkdir(e,{recursive:!0});let t=we(),o=u.join(e,t);return await p.promises.writeFile(o,r,{mode:384}),l.info(`Saved image: ${o}`),await this.cleanup(),await this.ensureGitIgnored(),o},async cleanup(){let e=B().get("maxImages",20),t=Number.isInteger(e)&&e>0?e:20,o=j(),a;try{a=await p.promises.readdir(o)}catch{return}let i=a.filter(s=>s.endsWith(".png")).sort();if(i.length<=t)return;let c=i.slice(0,i.length-t);for(let s of c){let m=u.join(o,s);try{await p.promises.unlink(m),l.info(`Deleted old image: ${m}`)}catch(W){l.warn(`Failed to delete old image: ${m}`,W)}}},async ensureGitIgnored(){if(!B().get("autoGitIgnore",!0))return;let e=Y(),t=U(),o=u.join(t,".gitignore"),a;try{a=await p.promises.readFile(o,"utf-8")}catch{await p.promises.writeFile(o,e+`
`,"utf-8"),l.info(`Created .gitignore with ${e}`);return}if(a.split(`
`).map(s=>s.trim()).includes(e))return;let c=a.endsWith(`
`)?"":`
`;await p.promises.writeFile(o,a+c+e+`
`,"utf-8"),l.info(`Added ${e} to .gitignore`)}}}var v=f(require("vscode"));function M(r){let e=v.window.activeTerminal;if(!e){v.window.showErrorMessage("Terminal Image Paste: No active terminal. Please open a terminal first.");return}let t="'"+r.replace(/'/g,"'\\''")+"'",a=v.workspace.getConfiguration("terminalImgPaste").get("sendNewline",!1);e.sendText(t,a),l.info(`Inserted path into terminal: ${t}`)}var A=class{_queue=[];_locked=!1;acquire(){return new Promise(e=>{let t=()=>{this._locked?this._queue.push(t):(this._locked=!0,e(()=>{this._locked=!1;let o=this._queue.shift();o&&o()}))};t()})}};function J(r,e){let t=e instanceof Error?e.message:String(e);d.window.showErrorMessage(`Terminal Image Paste: ${t}`),l.error(`${r} command failed`,e)}function he(r){let e=D(),t=O(e),o=H();t.isToolAvailable().then(s=>{s||d.window.showWarningMessage(`Terminal Image Paste: clipboard tool "${t.requiredTool()}" not found. Install it to use clipboard image pasting.`)}).catch(s=>{l.error("Failed to check tool availability",s)});let a=new A,i=d.commands.registerCommand("terminalImgPaste.pasteImage",async()=>{let s=await a.acquire();try{if(!await t.isToolAvailable()){d.window.showWarningMessage(`Terminal Image Paste: "${t.requiredTool()}" is not installed. Please install it to paste clipboard images.`);return}if(!await t.hasImage()){d.window.showInformationMessage("No image found in clipboard.");return}let X=await t.readImage(),V=await o.save(X);M(V),d.window.setStatusBarMessage("Image pasted to terminal",3e3)}catch(m){J("pasteImage",m)}finally{s()}}),c=d.commands.registerCommand("terminalImgPaste.sendPathToTerminal",async s=>{try{if(!s?.fsPath){d.window.showErrorMessage("Terminal Image Paste: No file selected.");return}M(s.fsPath),d.window.setStatusBarMessage("Path sent to terminal",3e3)}catch(m){J("sendPathToTerminal",m)}});r.subscriptions.push(i,c),l.info(`Extension activated (platform: ${e.os}, WSL: ${e.isWSL})`)}function be(){l.info("Extension deactivating")}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
