"use strict";var X=Object.create;var v=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var Q=(e,t)=>{for(var r in t)v(e,r,{get:t[r],enumerable:!0})},W=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of V(t))!K.call(e,s)&&s!==r&&v(e,s,{get:()=>t[s],enumerable:!(o=J(t,s))||o.enumerable});return e};var f=(e,t,r)=>(r=e!=null?X(z(e)):{},W(t||!e||!e.__esModule?v(r,"default",{value:e,enumerable:!0}):r,e)),Z=e=>W(v({},"__esModule",{value:!0}),e);var pe={};Q(pe,{activate:()=>fe,deactivate:()=>ue});module.exports=Z(pe);var d=f(require("vscode"));var S=f(require("fs")),x=null;function ee(){switch(process.platform){case"darwin":return"macos";case"win32":return"windows";default:return"linux"}}function te(){try{let e=S.readFileSync("/proc/version","utf-8");return/microsoft/i.test(e)}catch{return!1}}function re(e,t){if(e!=="linux"||t)return"unknown";let r=process.env.XDG_SESSION_TYPE;return r==="wayland"?"wayland":r==="x11"?"x11":process.env.WAYLAND_DISPLAY?"wayland":"unknown"}function oe(e,t){if(e==="windows")return"powershell.exe";if(t){let r=["/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe","/mnt/c/Program Files/PowerShell/7/pwsh.exe"];for(let o of r)if(S.existsSync(o))return o;return"powershell.exe"}return null}function B(){if(x)return x;let e=ee(),t=e==="linux"?te():!1,r=re(e,t),o=oe(e,t);return x={os:e,isWSL:t,displayServer:r,powershellPath:o},x}var $=require("child_process"),_=1e4,se=10*1024*1024,ne=50*1024*1024;function M(e){return"code"in e&&typeof e.code=="number"?e.code:e.code??"unknown"}function l(e,t,r){return new Promise((o,s)=>{(0,$.execFile)(e,t,{encoding:"utf-8",timeout:r?.timeout??_,maxBuffer:r?.maxBuffer??se,cwd:r?.cwd},(a,c,n)=>{if(a){s(new Error(`Command "${e}" failed (exit code ${M(a)}): ${n||a.message}`));return}o({stdout:c,stderr:n})})})}function w(e,t,r){return new Promise((o,s)=>{(0,$.execFile)(e,t,{encoding:"buffer",timeout:r?.timeout??_,maxBuffer:r?.maxBuffer??ne,cwd:r?.cwd},(a,c,n)=>{let m=n instanceof Buffer?n.toString("utf-8"):String(n);if(a){s(new Error(`Command "${e}" failed (exit code ${M(a)}): ${m||a.message}`));return}o({stdout:c,stderr:m})})})}var y=class{requiredTool(){return"pngpaste"}async isToolAvailable(){try{return await l("which",["pngpaste"]),!0}catch{return!1}}async hasImage(){try{let{stdout:t}=await l("osascript",["-e","clipboard info"]);return t.includes("\xABclass PNGf\xBB")||t.includes("\xABclass TIFF\xBB")}catch{return!1}}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let{stdout:r}=await w("pngpaste",["-"]);return r}};var I=class{displayServer;constructor(t){this.displayServer=t}isWayland(){return this.displayServer==="wayland"}requiredTool(){return this.isWayland()?"wl-clipboard (wl-paste)":"xclip"}async isToolAvailable(){try{return this.isWayland()?await l("which",["wl-paste"]):await l("which",["xclip"]),!0}catch{return!1}}async hasImage(){try{if(this.isWayland()){let{stdout:t}=await l("wl-paste",["--list-types"]);return t.includes("image/png")}else{let{stdout:t}=await l("xclip",["-selection","clipboard","-t","TARGETS","-o"]);return t.includes("image/png")}}catch{return!1}}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");if(this.isWayland()){let{stdout:r}=await w("wl-paste",["--type","image/png"]);return r}else{let{stdout:r}=await w("xclip",["-selection","clipboard","-t","image/png","-o"]);return r}}};var C=f(require("fs"));var L=f(require("vscode"));function A(){let e=new Date,t=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0"),o=String(e.getSeconds()).padStart(2,"0"),s=String(e.getMilliseconds()).padStart(3,"0");return`[${t}:${r}:${o}.${s}]`}function ae(e){let t=L.window.createOutputChannel(e);return{info(r){t.appendLine(`${A()} [INFO] ${r}`)},warn(r){t.appendLine(`${A()} [WARN] ${r}`)},error(r,o){let s=`${A()} [ERROR] ${r}`;o!==void 0&&(o instanceof Error&&o.stack?s+=`
${o.stack}`:s+=`
${String(o)}`),t.appendLine(s)},show(){t.show()}}}var i=ae("Terminal Image Paste");var ie="Add-Type -AssemblyName System.Windows.Forms; if ([System.Windows.Forms.Clipboard]::ContainsImage()) { echo 'yes' } else { echo 'no' }",le="Add-Type -AssemblyName System.Windows.Forms; $img = [System.Windows.Forms.Clipboard]::GetImage(); if ($img -eq $null) { exit 1 }; $tmp = [System.IO.Path]::GetTempFileName(); $img.Save($tmp, [System.Drawing.Imaging.ImageFormat]::Png); Write-Output $tmp",g=class{async isToolAvailable(){try{return await l(this.powershellExe,["-Command","echo ok"]),!0}catch{return!1}}async hasImage(){try{return(await l(this.powershellExe,["-Command",ie])).stdout.trim()==="yes"}catch{return!1}}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let r=await l(this.powershellExe,["-Command",le]),o=await this.resolveTempPath(r.stdout.trim());try{return await C.promises.readFile(o)}finally{C.promises.unlink(o).catch(s=>{i.warn(`Failed to clean up temp file: ${o}`,s)})}}};var b=class extends g{get powershellExe(){return"powershell.exe"}requiredTool(){return"PowerShell (built-in)"}async resolveTempPath(t){return t}};var E=class extends g{psPath;constructor(t){super(),this.psPath=t.powershellPath??"powershell.exe"}get powershellExe(){return this.psPath}requiredTool(){return"PowerShell (via WSL interop)"}async resolveTempPath(t){return(await l("wslpath",["-u",t])).stdout.trim()}};function D(e){if(e.isWSL)return new E(e);switch(e.os){case"macos":return new y;case"windows":return new b;case"linux":return new I(e.displayServer)}}var u=f(require("fs")),p=f(require("path")),h=f(require("vscode"));var ce=".tip-images",F=Buffer.from([137,80,78,71,13,10,26,10]);function me(e){if(e.length<F.length||!e.subarray(0,F.length).equals(F))throw new Error("Clipboard data is not a valid PNG image")}function N(){return h.workspace.getConfiguration("terminalImgPaste")}function G(){let e=h.workspace.workspaceFolders;if(!e||e.length===0)throw h.window.showErrorMessage("Terminal Image Paste: No workspace folder is open. Please open a folder first."),new Error("No workspace folder is open");return e[0].uri.fsPath}function O(){return N().get("folderName",ce)}function q(){let e=G(),t=O(),r=p.resolve(e,t);if(!r.startsWith(e+p.sep))throw new Error(`Configured folderName "${t}" must resolve to a subdirectory of the workspace root`);return r}function de(){let e=new Date,t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),c=String(e.getSeconds()).padStart(2,"0"),n=String(e.getMilliseconds()).padStart(3,"0");return`img-${t}-${r}-${o}T${s}-${a}-${c}-${n}.png`}function U(){return{async save(e){me(e);let t=q();await u.promises.mkdir(t,{recursive:!0});let r=de(),o=p.join(t,r);return await u.promises.writeFile(o,e,{mode:384}),i.info(`Saved image: ${o}`),await this.cleanup(),await this.ensureGitIgnored(),o},async cleanup(){let t=N().get("maxImages",20),r=Number.isInteger(t)&&t>0?t:20,o=q(),s;try{s=await u.promises.readdir(o)}catch{return}let a=s.filter(n=>n.endsWith(".png")).sort();if(a.length<=r)return;let c=a.slice(0,a.length-r);for(let n of c){let m=p.join(o,n);try{await u.promises.unlink(m),i.info(`Deleted old image: ${m}`)}catch(k){i.warn(`Failed to delete old image: ${m}`,k)}}},async ensureGitIgnored(){if(!N().get("autoGitIgnore",!0))return;let t=O(),r=G(),o=p.join(r,".gitignore"),s;try{s=await u.promises.readFile(o,"utf-8")}catch{await u.promises.writeFile(o,t+`
`,"utf-8"),i.info(`Created .gitignore with ${t}`);return}if(s.split(`
`).map(n=>n.trim()).includes(t))return;let c=s.endsWith(`
`)?"":`
`;await u.promises.writeFile(o,s+c+t+`
`,"utf-8"),i.info(`Added ${t} to .gitignore`)}}}var P=f(require("vscode"));function R(e){let t=P.window.activeTerminal;if(!t){P.window.showErrorMessage("Terminal Image Paste: No active terminal. Please open a terminal first.");return}let r="'"+e.replace(/'/g,"'\\''")+"'",s=P.workspace.getConfiguration("terminalImgPaste").get("sendNewline",!1);t.sendText(r,s),i.info(`Inserted path into terminal: ${r}`)}var T=class{_queue=[];_locked=!1;acquire(){return new Promise(t=>{let r=()=>{this._locked?this._queue.push(r):(this._locked=!0,t(()=>{this._locked=!1;let o=this._queue.shift();o&&o()}))};r()})}};function Y(e,t){let r=t instanceof Error?t.message:String(t);d.window.showErrorMessage(`Terminal Image Paste: ${r}`),i.error(`${e} command failed`,t)}function fe(e){let t=B(),r=D(t),o=U();r.isToolAvailable().then(n=>{n||d.window.showWarningMessage(`Terminal Image Paste: clipboard tool "${r.requiredTool()}" not found. Install it to use clipboard image pasting.`)}).catch(n=>{i.error("Failed to check tool availability",n)});let s=new T,a=d.commands.registerCommand("terminalImgPaste.pasteImage",async()=>{let n=await s.acquire();try{if(!await r.isToolAvailable()){d.window.showWarningMessage(`Terminal Image Paste: "${r.requiredTool()}" is not installed. Please install it to paste clipboard images.`);return}if(!await r.hasImage()){d.window.showInformationMessage("No image found in clipboard.");return}let j=await r.readImage(),H=await o.save(j);R(H),d.window.setStatusBarMessage("Image pasted to terminal",3e3)}catch(m){Y("pasteImage",m)}finally{n()}}),c=d.commands.registerCommand("terminalImgPaste.sendPathToTerminal",async n=>{try{if(!n?.fsPath){d.window.showErrorMessage("Terminal Image Paste: No file selected.");return}R(n.fsPath),d.window.setStatusBarMessage("Path sent to terminal",3e3)}catch(m){Y("sendPathToTerminal",m)}});e.subscriptions.push(a,c),i.info(`Extension activated (platform: ${t.os}, WSL: ${t.isWSL})`)}function ue(){i.info("Extension deactivating")}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
