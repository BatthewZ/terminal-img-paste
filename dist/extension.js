"use strict";var ge=Object.create;var R=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var he=Object.getOwnPropertyNames;var be=Object.getPrototypeOf,ye=Object.prototype.hasOwnProperty;var ve=(t,e)=>{for(var r in e)R(t,r,{get:e[r],enumerable:!0})},z=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of he(e))!ye.call(t,a)&&a!==r&&R(t,a,{get:()=>e[a],enumerable:!(o=we(e,a))||o.enumerable});return t};var f=(t,e,r)=>(r=t!=null?ge(be(t)):{},z(e||!t||!t.__esModule?R(r,"default",{value:t,enumerable:!0}):r,t)),Pe=t=>z(R({},"__esModule",{value:!0}),t);var Xe={};ve(Xe,{activate:()=>Je,deactivate:()=>He});module.exports=Pe(Xe);var d=f(require("vscode"));var A=f(require("fs")),k=null;function xe(){switch(process.platform){case"darwin":return"macos";case"win32":return"windows";default:return"linux"}}function Se(){try{let t=A.readFileSync("/proc/version","utf-8");return/microsoft/i.test(t)}catch{return!1}}function Ie(t,e){if(t!=="linux")return"unknown";if(e)return process.env.WAYLAND_DISPLAY?"wayland":process.env.DISPLAY?"x11":"unknown";let r=process.env.XDG_SESSION_TYPE;return r==="wayland"?"wayland":r==="x11"?"x11":process.env.WAYLAND_DISPLAY?"wayland":"unknown"}function Ce(t,e){if(t==="windows")return"powershell.exe";if(e){let r=["/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe","/mnt/c/Program Files/PowerShell/7/pwsh.exe"];for(let o of r)if(A.existsSync(o))return o;return"powershell.exe"}return null}function V(){if(k)return k;let t=xe(),e=t==="linux"?Se():!1,r=Ie(t,e),o=Ce(t,e);return k={os:t,isWSL:e,displayServer:r,powershellPath:o},k}var K=f(require("vscode"));function Q(){let t=K.env.remoteName;return t?{remote:!0,type:t}:{remote:!1}}var I=require("child_process"),L=1e4,Ee=10*1024*1024,Z=50*1024*1024;function j(t){return"code"in t&&typeof t.code=="number"?t.code:t.code??"unknown"}function c(t,e,r){return new Promise((o,a)=>{(0,I.execFile)(t,e,{encoding:"utf-8",timeout:r?.timeout??L,maxBuffer:r?.maxBuffer??Ee,cwd:r?.cwd},(s,i,n)=>{if(s){a(new Error(`Command "${t}" failed (exit code ${j(s)}): ${n||s.message}`));return}o({stdout:i,stderr:n})})})}function u(t,e,r){return r?.input?Te(t,e,r):new Promise((o,a)=>{(0,I.execFile)(t,e,{encoding:"buffer",timeout:r?.timeout??L,maxBuffer:r?.maxBuffer??Z,cwd:r?.cwd},(s,i,n)=>{let l=n instanceof Buffer?n.toString("utf-8"):String(n);if(s){a(new Error(`Command "${t}" failed (exit code ${j(s)}): ${l||s.message}`));return}o({stdout:i,stderr:l})})})}function Te(t,e,r){let o=r.timeout??L,a=r.maxBuffer??Z;return new Promise((s,i)=>{let n=(0,I.spawn)(t,e,{stdio:["pipe","pipe","pipe"],cwd:r.cwd}),l=[],w=[],_=0,O=0,g=!1,x=setTimeout(()=>{g||(g=!0,n.kill("SIGTERM"),i(new Error(`Command "${t}" failed (exit code ETIMEDOUT): timed out after ${o}ms`)))},o);n.stdout.on("data",p=>{if(_+=p.length,_>a){g||(g=!0,clearTimeout(x),n.kill("SIGTERM"),i(new Error(`Command "${t}" failed (exit code ERR_CHILD_PROCESS_STDIO_MAXBUFFER): stdout maxBuffer length exceeded`)));return}l.push(p)}),n.stderr.on("data",p=>{O+=p.length,O<=a&&w.push(p)}),n.on("error",p=>{g||(g=!0,clearTimeout(x),i(new Error(`Command "${t}" failed (exit code ${j(p)}): ${p.message}`)))}),n.on("close",p=>{if(g)return;g=!0,clearTimeout(x);let S=Buffer.concat(w).toString("utf-8");if(p!==0){i(new Error(`Command "${t}" failed (exit code ${p??"unknown"}): ${S||`process exited with code ${p}`}`));return}s({stdout:Buffer.concat(l),stderr:S})}),n.stdin.on("error",()=>{}),n.stdin.end(r.input)})}async function C(){let{stdout:t}=await c("osascript",["-e","clipboard info"]);return t}function E(t){let e=[];return t.includes("\xABclass PNGf\xBB")&&e.push("png"),(t.includes("\xABclass JPEG\xBB")||t.includes("\xABclass JPEf\xBB"))&&e.push("jpeg"),t.includes("\xABclass TIFF\xBB")&&e.push("tiff"),(t.includes("\xABclass BMP \xBB")||t.includes("\xABclass BMPf\xBB"))&&e.push("bmp"),e}var B=class{requiredTool(){return"pngpaste"}async isToolAvailable(){try{return await c("which",["pngpaste"]),!0}catch{return!1}}async hasImage(){try{let e=await C();return E(e).length>0}catch{return!1}}async detectFormat(){let e=await C(),r=E(e);if(r.length>0)return r[0];throw new Error("No image found in clipboard")}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let{stdout:r}=await u("pngpaste",["-"]);return{data:r,format:"png"}}};var ee={png:"PNGf",jpeg:"JPEG",tiff:"TIFF"},N=class{requiredTool(){return"osascript (built-in)"}async isToolAvailable(){return process.platform==="darwin"}async hasImage(){try{let e=await C();return E(e).length>0}catch{return!1}}async detectFormat(){let e=await C(),r=E(e);if(r.length>0)return r[0];throw new Error("No image found in clipboard")}async readImage(){let e=await this.detectFormat(),r=e in ee,o=r?ee[e]:"PNGf",a=r?e:"png",{stdout:s}=await u("osascript",["-e",`set imgData to (the clipboard as \xABclass ${o}\xBB)`,"-e","return imgData"]);return{data:s,format:a}}};var te=[["image/png","png"],["image/jpeg","jpeg"],["image/webp","webp"],["image/tiff","tiff"],["image/bmp","bmp"],["image/x-bmp","bmp"]];function Fe(t){for(let[e,r]of te)if(t.includes(e))return r;return/^image\//m.test(t)?"unknown":null}function $e(t){for(let[e,r]of te)if(t.includes(e))return{mime:e,format:r};return/^image\//m.test(t)?{mime:"image/png",format:"unknown"}:null}var y=class{displayServer;constructor(e){this.displayServer=e}isWayland(){return this.displayServer==="wayland"}requiredTool(){return this.isWayland()?"wl-clipboard (wl-paste)":"xclip"}async isToolAvailable(){try{return this.isWayland()?await c("which",["wl-paste"]):await c("which",["xclip"]),!0}catch{return!1}}async getClipboardTypes(){if(this.isWayland()){let{stdout:e}=await c("wl-paste",["--list-types"]);return e}else{let{stdout:e}=await c("xclip",["-selection","clipboard","-t","TARGETS","-o"]);return e}}async hasImage(){try{let e=await this.getClipboardTypes();return/^image\//m.test(e)}catch{return!1}}async detectFormat(){let e=await this.getClipboardTypes(),r=Fe(e);if(r!==null)return r;throw new Error("No image found in clipboard")}async readImage(){let e=await this.getClipboardTypes(),r=$e(e);if(!r)throw new Error("No image found in clipboard");let{mime:o,format:a}=r,s=a==="unknown"?"png":a,{stdout:i}=this.isWayland()?await u("wl-paste",["--type",o]):await u("xclip",["-selection","clipboard","-t",o,"-o"]);return{data:i,format:s}}};var q=f(require("fs"));var re=f(require("vscode"));function G(){let t=new Date,e=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0"),a=String(t.getMilliseconds()).padStart(3,"0");return`[${e}:${r}:${o}.${a}]`}function Re(t){let e=re.window.createOutputChannel(t);return{info(r){e.appendLine(`${G()} [INFO] ${r}`)},warn(r,o){let a=`${G()} [WARN] ${r}`;o!==void 0&&(o instanceof Error&&o.stack?a+=`
${o.stack}`:a+=`
${String(o)}`),e.appendLine(a)},error(r,o){let a=`${G()} [ERROR] ${r}`;o!==void 0&&(o instanceof Error&&o.stack?a+=`
${o.stack}`:a+=`
${String(o)}`),e.appendLine(a)},show(){e.show()}}}var m=Re("Terminal Image Paste");var ke="Add-Type -AssemblyName System.Windows.Forms; if ([System.Windows.Forms.Clipboard]::ContainsImage()) { echo 'yes' } else { echo 'no' }",Ae="Add-Type -AssemblyName System.Windows.Forms; $img = [System.Windows.Forms.Clipboard]::GetImage(); if ($img -eq $null) { exit 1 }; $tmp = [System.IO.Path]::GetTempFileName(); $img.Save($tmp, [System.Drawing.Imaging.ImageFormat]::Png); Write-Output $tmp",v=class{async isToolAvailable(){try{return await c(this.powershellExe,["-Command","echo ok"]),!0}catch{return!1}}async hasImage(){try{return(await c(this.powershellExe,["-Command",ke])).stdout.trim()==="yes"}catch{return!1}}async detectFormat(){if(!await this.hasImage())throw new Error("No image found in clipboard");return"png"}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let r=await c(this.powershellExe,["-Command",Ae]),o=await this.resolveTempPath(r.stdout.trim());try{return{data:await q.promises.readFile(o),format:"png"}}finally{q.promises.unlink(o).catch(a=>{m.warn(`Failed to clean up temp file: ${o}`,a)})}}};var M=class extends v{get powershellExe(){return"powershell.exe"}requiredTool(){return"PowerShell (built-in)"}async resolveTempPath(e){return e}};var W=class extends v{psPath;constructor(e){super(),this.psPath=e.powershellPath??"powershell.exe"}get powershellExe(){return this.psPath}requiredTool(){return"PowerShell (via WSL interop)"}async resolveTempPath(e){return(await c("wslpath",["-u",e])).stdout.trim()}};var P=class{readers;constructor(e){if(e.length===0)throw new Error("FallbackClipboardReader requires at least one reader");this.readers=e}requiredTool(){return this.readers.map(e=>e.requiredTool()).join(" or ")}async isToolAvailable(){for(let e of this.readers)if(await e.isToolAvailable())return!0;return!1}async hasImage(){for(let e of this.readers)try{if(await e.hasImage())return!0}catch{continue}return!1}async detectFormat(){let e=[];for(let r of this.readers)try{return await r.detectFormat()}catch(o){e.push(o instanceof Error?o:new Error(String(o)))}throw new AggregateError(e,`All clipboard readers failed to detect format: ${e.map(r=>r.message).join("; ")}`)}async readImage(){let e=[];for(let r of this.readers)try{if(!await r.isToolAvailable()){e.push(new Error(`${r.requiredTool()}: tool not available`));continue}return await r.readImage()}catch(o){e.push(o instanceof Error?o:new Error(String(o)))}throw new AggregateError(e,`All clipboard readers failed: ${e.map(r=>r.message).join("; ")}`)}};function oe(t){if(t.isWSL){let e=[new W(t)];return(t.displayServer==="x11"||t.displayServer==="wayland")&&e.push(new y(t.displayServer)),e.length===1?e[0]:new P(e)}switch(t.os){case"macos":return new P([new B,new N]);case"windows":return new M;case"linux":{let e=new y(t.displayServer),r=t.displayServer==="wayland"?"x11":"wayland",o=new y(r);return new P([e,o])}}}var h=f(require("fs")),b=f(require("path")),T=f(require("vscode"));var Be=".tip-images",Ne=[".png",".jpg",".jpeg",".tiff",".bmp",".webp"];function Me(t){switch(t){case"jpeg":return".jpg";case"tiff":return".tiff";case"bmp":return".bmp";case"webp":return".webp";case"png":case"unknown":default:return".png"}}var U=Buffer.from([137,80,78,71,13,10,26,10]);function We(t,e){switch(e){case"png":if(t.length<U.length||!t.subarray(0,U.length).equals(U))throw new Error("Clipboard data is not a valid PNG image");break;case"jpeg":if(t.length<2||t[0]!==255||t[1]!==216)throw new Error("Clipboard data is not a valid JPEG image");break;case"bmp":if(t.length<2||t[0]!==66||t[1]!==77)throw new Error("Clipboard data is not a valid BMP image");break;case"webp":if(t.length<12||t.subarray(0,4).toString("ascii")!=="RIFF"||t.subarray(8,12).toString("ascii")!=="WEBP")throw new Error("Clipboard data is not a valid WebP image");break;case"tiff":if(t.length<2||!(t[0]===73&&t[1]===73||t[0]===77&&t[1]===77))throw new Error("Clipboard data is not a valid TIFF image");break;case"unknown":m.warn("Skipping image validation for unknown format");break}}function Y(){return T.workspace.getConfiguration("terminalImgPaste")}function ne(){let t=T.workspace.workspaceFolders;if(!t||t.length===0)throw T.window.showErrorMessage("Terminal Image Paste: No workspace folder is open. Please open a folder first."),new Error("No workspace folder is open");return t[0].uri.fsPath}function se(){return Y().get("folderName",Be)}function ae(){let t=ne(),e=se(),r=b.resolve(t,e);if(!r.startsWith(t+b.sep))throw new Error(`Configured folderName "${e}" must resolve to a subdirectory of the workspace root`);return r}function De(t){let e=new Date,r=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),s=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),n=String(e.getSeconds()).padStart(2,"0"),l=String(e.getMilliseconds()).padStart(3,"0"),w=Me(t);return`img-${r}-${o}-${a}T${s}-${i}-${n}-${l}${w}`}function ie(){return{async save(t,e="png"){We(t,e);let r=ae();await h.promises.mkdir(r,{recursive:!0});let o=De(e),a=b.join(r,o);return await h.promises.writeFile(a,t,{mode:384}),m.info(`Saved image: ${a}`),await this.cleanup(),await this.ensureGitIgnored(),a},async cleanup(){let e=Y().get("maxImages",20),r=Number.isInteger(e)&&e>0?e:20,o=ae(),a;try{a=await h.promises.readdir(o)}catch{return}let s=a.filter(n=>Ne.some(l=>n.endsWith(l))).sort();if(s.length<=r)return;let i=s.slice(0,s.length-r);for(let n of i){let l=b.join(o,n);try{await h.promises.unlink(l),m.info(`Deleted old image: ${l}`)}catch(w){m.warn(`Failed to delete old image: ${l}`,w)}}},async ensureGitIgnored(){if(!Y().get("autoGitIgnore",!0))return;let e=se(),r=ne(),o=b.join(r,".gitignore"),a;try{a=await h.promises.readFile(o,"utf-8")}catch{await h.promises.writeFile(o,e+`
`,"utf-8"),m.info(`Created .gitignore with ${e}`);return}if(a.split(`
`).map(n=>n.trim()).includes(e))return;let i=a.endsWith(`
`)?"":`
`;await h.promises.writeFile(o,a+i+e+`
`,"utf-8"),m.info(`Added ${e} to .gitignore`)}}}var F=f(require("vscode"));var ce=f(require("path")),_e=[{pattern:/\bbash\b/i,type:"bash"},{pattern:/\bzsh\b/i,type:"zsh"},{pattern:/\bfish\b/i,type:"fish"},{pattern:/\b(?:pwsh|powershell)\b/i,type:"powershell"},{pattern:/\bcmd\b/i,type:"cmd"}];function le(t){let e=ce.basename(t).replace(/\.exe$/i,"");for(let{pattern:r,type:o}of _e)if(r.test(e))return o;return"unknown"}function me(t){let e=t.creationOptions?.shellPath;if(e)return le(e);let r=process.env.SHELL;return r?le(r):process.platform==="win32"?"powershell":"unknown"}function Oe(t,e){switch(e){case"fish":return"'"+t.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'";case"powershell":return'"'+t.replace(/`/g,"``").replace(/\$/g,"`$").replace(/"/g,'`"')+'"';case"cmd":return'"'+t.replace(/%/g,"%%").replace(/"/g,'""')+'"';case"bash":case"zsh":case"unknown":default:return"'"+t.replace(/'/g,"'\\''")+"'"}}function J(t){let e=F.window.activeTerminal;if(!e){F.window.showErrorMessage("Terminal Image Paste: No active terminal. Please open a terminal first.");return}let r=me(e),o=Oe(t,r),s=F.workspace.getConfiguration("terminalImgPaste").get("sendNewline",!1);e.sendText(o,s),m.info(`Inserted path into terminal (${r}): ${o}`)}var $=f(require("fs")),pe=f(require("os")),H=f(require("path"));async function de(t,e,r,o){if(r==="auto"||e===r)return{data:t,format:e};try{return{data:await je(t,e,r,o),format:r}}catch(a){return m.warn(`Image conversion from ${e} to ${r} failed, saving in native format: ${a instanceof Error?a.message:String(a)}`),{data:t,format:e}}}async function Le(t){if(t.os==="macos")return"sips";if(t.os==="windows"||t.isWSL)return t.powershellPath?"powershell":null;try{return await c("which",["convert"]),"magick"}catch{}try{return await c("which",["ffmpeg"]),"ffmpeg"}catch{}return null}async function je(t,e,r,o){let a=await Le(o);if(a===null)throw new Error("No conversion tool available");switch(a){case"sips":return Ge(t,r);case"magick":return qe(t,e,r);case"ffmpeg":return Ue(t,r);case"powershell":return Ye(t,r,o.powershellPath)}}async function Ge(t,e){let r=pe.tmpdir(),o=H.join(r,`tip-convert-in-${Date.now()}`),a=e==="jpeg"?"jpg":"png",s=H.join(r,`tip-convert-out-${Date.now()}.${a}`);await $.promises.writeFile(o,t,{mode:384});try{return await c("sips",["--setProperty","format",e==="jpeg"?"jpeg":"png",o,"--out",s]),await $.promises.readFile(s)}finally{await $.promises.unlink(o).catch(()=>{}),await $.promises.unlink(s).catch(()=>{})}}async function qe(t,e,r){let o=`${e}:-`,a=`${r}:-`;return(await u("convert",[o,a],{input:t})).stdout}async function Ue(t,e){return(await u("ffmpeg",["-hide_banner","-loglevel","error","-f","image2pipe","-i","-","-f","image2","-c:v",e==="png"?"png":"mjpeg","-"],{input:t})).stdout}async function Ye(t,e,r){return(await u(r,["-NoProfile","-Command",`
Add-Type -AssemblyName System.Drawing
$stdin = [Console]::OpenStandardInput()
$ms = New-Object System.IO.MemoryStream
$stdin.CopyTo($ms)
$ms.Position = 0
$img = [System.Drawing.Image]::FromStream($ms)
$outMs = New-Object System.IO.MemoryStream
$img.Save($outMs, [System.Drawing.Imaging.ImageFormat]::${e==="png"?"Png":"Jpeg"})
[Console]::OpenStandardOutput().Write($outMs.ToArray(), 0, $outMs.Length)
$img.Dispose()
$ms.Dispose()
$outMs.Dispose()
`],{input:t})).stdout}var D=class{_queue=[];_locked=!1;acquire(){return new Promise(e=>{let r=()=>{this._locked?this._queue.push(r):(this._locked=!0,e(()=>{this._locked=!1;let o=this._queue.shift();o&&o()}))};r()})}};function fe(t,e){let r=e instanceof Error?e.message:String(e);d.window.showErrorMessage(`Terminal Image Paste: ${r}`),m.error(`${t} command failed`,e)}function Je(t){let e=V(),r=oe(e),o=ie();r.isToolAvailable().then(n=>{n||d.window.showWarningMessage(`Terminal Image Paste: clipboard tool "${r.requiredTool()}" not found. Install it to use clipboard image pasting.`)}).catch(n=>{m.error("Failed to check tool availability",n)});let a=new D,s=d.commands.registerCommand("terminalImgPaste.pasteImage",async()=>{let n=await a.acquire();try{if(!await r.isToolAvailable()){d.window.showWarningMessage(`Terminal Image Paste: "${r.requiredTool()}" is not installed. Please install it to paste clipboard images.`);return}let w=d.workspace.getConfiguration("terminalImgPaste");if(w.get("warnOnRemote",!0)){let X=Q();if(X.remote&&X.type!=="wsl"&&await d.window.showWarningMessage("Clipboard images are saved locally. The pasted path may not be accessible from the remote terminal.","Paste Anyway","Cancel")!=="Paste Anyway")return}if(!await r.hasImage()){d.window.showInformationMessage("No image found in clipboard.");return}let{data:g,format:x}=await r.readImage(),p=w.get("saveFormat","auto"),S=await de(g,x,p,e),ue=await o.save(S.data,S.format);J(ue),d.window.setStatusBarMessage("Image pasted to terminal",3e3)}catch(l){fe("pasteImage",l)}finally{n()}}),i=d.commands.registerCommand("terminalImgPaste.sendPathToTerminal",async n=>{try{if(!n?.fsPath){d.window.showErrorMessage("Terminal Image Paste: No file selected.");return}J(n.fsPath),d.window.setStatusBarMessage("Path sent to terminal",3e3)}catch(l){fe("sendPathToTerminal",l)}});t.subscriptions.push(s,i),m.info(`Extension activated (platform: ${e.os}, WSL: ${e.isWSL})`)}function He(){m.info("Extension deactivating")}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
