"use strict";var H=Object.create;var v=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var V=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var K=(t,e)=>{for(var r in e)v(t,r,{get:e[r],enumerable:!0})},k=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of J(e))!z.call(t,s)&&s!==r&&v(t,s,{get:()=>e[s],enumerable:!(o=X(e,s))||o.enumerable});return t};var f=(t,e,r)=>(r=t!=null?H(V(t)):{},k(e||!t||!t.__esModule?v(r,"default",{value:t,enumerable:!0}):r,t)),Q=t=>k(v({},"__esModule",{value:!0}),t);var fe={};K(fe,{activate:()=>me,deactivate:()=>de});module.exports=Q(fe);var d=f(require("vscode"));var S=f(require("fs")),x=null;function Z(){switch(process.platform){case"darwin":return"macos";case"win32":return"windows";default:return"linux"}}function ee(){try{let t=S.readFileSync("/proc/version","utf-8");return/microsoft/i.test(t)}catch{return!1}}function te(t,e){if(t!=="linux"||e)return"unknown";let r=process.env.XDG_SESSION_TYPE;return r==="wayland"?"wayland":r==="x11"?"x11":process.env.WAYLAND_DISPLAY?"wayland":"unknown"}function re(t,e){if(t==="windows")return"powershell.exe";if(e){let r=["/mnt/c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe","/mnt/c/Program Files/PowerShell/7/pwsh.exe"];for(let o of r)if(S.existsSync(o))return o;return"powershell.exe"}return null}function W(){if(x)return x;let t=Z(),e=t==="linux"?ee():!1,r=te(t,e),o=re(t,e);return x={os:t,isWSL:e,displayServer:r,powershellPath:o},x}var $=require("child_process"),B=1e4,oe=10*1024*1024,se=50*1024*1024;function _(t){return"code"in t&&typeof t.code=="number"?t.code:t.code??"unknown"}function l(t,e,r){return new Promise((o,s)=>{(0,$.execFile)(t,e,{encoding:"utf-8",timeout:r?.timeout??B,maxBuffer:r?.maxBuffer??oe,cwd:r?.cwd},(i,c,n)=>{if(i){s(new Error(`Command "${t}" failed (exit code ${_(i)}): ${n||i.message}`));return}o({stdout:c,stderr:n})})})}function w(t,e,r){return new Promise((o,s)=>{(0,$.execFile)(t,e,{encoding:"buffer",timeout:r?.timeout??B,maxBuffer:r?.maxBuffer??se,cwd:r?.cwd},(i,c,n)=>{let m=n instanceof Buffer?n.toString("utf-8"):String(n);if(i){s(new Error(`Command "${t}" failed (exit code ${_(i)}): ${m||i.message}`));return}o({stdout:c,stderr:m})})})}var y=class{requiredTool(){return"pngpaste"}async isToolAvailable(){try{return await l("which",["pngpaste"]),!0}catch{return!1}}async hasImage(){try{let{stdout:e}=await l("osascript",["-e","clipboard info"]);return e.includes("\xABclass PNGf\xBB")||e.includes("\xABclass TIFF\xBB")}catch{return!1}}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let{stdout:r}=await w("pngpaste",["-"]);return r}};var I=class{displayServer;constructor(e){this.displayServer=e}isWayland(){return this.displayServer==="wayland"}requiredTool(){return this.isWayland()?"wl-clipboard (wl-paste)":"xclip"}async isToolAvailable(){try{return this.isWayland()?await l("which",["wl-paste"]):await l("which",["xclip"]),!0}catch{return!1}}async hasImage(){try{if(this.isWayland()){let{stdout:e}=await l("wl-paste",["--list-types"]);return e.includes("image/png")}else{let{stdout:e}=await l("xclip",["-selection","clipboard","-t","TARGETS","-o"]);return e.includes("image/png")}}catch{return!1}}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");if(this.isWayland()){let{stdout:r}=await w("wl-paste",["--type","image/png"]);return r}else{let{stdout:r}=await w("xclip",["-selection","clipboard","-t","image/png","-o"]);return r}}};var F=f(require("fs"));var M=f(require("vscode"));function A(){let t=new Date,e=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0"),o=String(t.getSeconds()).padStart(2,"0"),s=String(t.getMilliseconds()).padStart(3,"0");return`[${e}:${r}:${o}.${s}]`}function ne(t){let e=M.window.createOutputChannel(t);return{info(r){e.appendLine(`${A()} [INFO] ${r}`)},warn(r){e.appendLine(`${A()} [WARN] ${r}`)},error(r,o){let s=`${A()} [ERROR] ${r}`;o!==void 0&&(o instanceof Error&&o.stack?s+=`
${o.stack}`:s+=`
${String(o)}`),e.appendLine(s)},show(){e.show()}}}var a=ne("Terminal Image Paste");var ie="Add-Type -AssemblyName System.Windows.Forms; if ([System.Windows.Forms.Clipboard]::ContainsImage()) { echo 'yes' } else { echo 'no' }",ae="Add-Type -AssemblyName System.Windows.Forms; $img = [System.Windows.Forms.Clipboard]::GetImage(); if ($img -eq $null) { exit 1 }; $tmp = [System.IO.Path]::GetTempFileName(); $img.Save($tmp, [System.Drawing.Imaging.ImageFormat]::Png); Write-Output $tmp",g=class{async isToolAvailable(){try{return await l(this.powershellExe,["-Command","echo ok"]),!0}catch{return!1}}async hasImage(){try{return(await l(this.powershellExe,["-Command",ie])).stdout.trim()==="yes"}catch{return!1}}async readImage(){if(!await this.hasImage())throw new Error("No image found in clipboard");let r=await l(this.powershellExe,["-Command",ae]),o=await this.resolveTempPath(r.stdout.trim());try{return await F.promises.readFile(o)}finally{F.promises.unlink(o).catch(s=>{a.warn(`Failed to clean up temp file: ${o}`,s)})}}};var b=class extends g{get powershellExe(){return"powershell.exe"}requiredTool(){return"PowerShell (built-in)"}async resolveTempPath(e){return e}};var E=class extends g{psPath;constructor(e){super(),this.psPath=e.powershellPath??"powershell.exe"}get powershellExe(){return this.psPath}requiredTool(){return"PowerShell (via WSL interop)"}async resolveTempPath(e){return(await l("wslpath",["-u",e])).stdout.trim()}};function L(t){if(t.isWSL)return new E(t);switch(t.os){case"macos":return new y;case"windows":return new b;case"linux":return new I(t.displayServer)}}var p=f(require("fs")),u=f(require("path")),h=f(require("vscode"));var le=".tip-images";function C(){return h.workspace.getConfiguration("terminalImgPaste")}function q(){let t=h.workspace.workspaceFolders;if(!t||t.length===0)throw h.window.showErrorMessage("Terminal Image Paste: No workspace folder is open. Please open a folder first."),new Error("No workspace folder is open");return t[0].uri.fsPath}function O(){return C().get("folderName",le)}function D(){let t=q(),e=O(),r=u.resolve(t,e);if(r!==t&&!r.startsWith(t+u.sep))throw new Error(`Configured folderName "${e}" resolves outside the workspace root`);return r}function ce(){let t=new Date,e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),s=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),c=String(t.getSeconds()).padStart(2,"0"),n=String(t.getMilliseconds()).padStart(3,"0");return`img-${e}-${r}-${o}T${s}-${i}-${c}-${n}.png`}function G(){return{async save(t){let e=D();await p.promises.mkdir(e,{recursive:!0});let r=ce(),o=u.join(e,r);return await p.promises.writeFile(o,t),a.info(`Saved image: ${o}`),await this.cleanup(),await this.ensureGitIgnored(),o},async cleanup(){let e=C().get("maxImages",20),r=Number.isInteger(e)&&e>0?e:20,o=D(),s;try{s=await p.promises.readdir(o)}catch{return}let i=s.filter(n=>n.endsWith(".png")).sort();if(i.length<=r)return;let c=i.slice(0,i.length-r);for(let n of c){let m=u.join(o,n);try{await p.promises.unlink(m),a.info(`Deleted old image: ${m}`)}catch(N){a.warn(`Failed to delete old image: ${m}`,N)}}},async ensureGitIgnored(){if(!C().get("autoGitIgnore",!0))return;let e=O(),r=q(),o=u.join(r,".gitignore"),s;try{s=await p.promises.readFile(o,"utf-8")}catch{await p.promises.writeFile(o,e+`
`,"utf-8"),a.info(`Created .gitignore with ${e}`);return}if(s.split(`
`).map(n=>n.trim()).includes(e))return;let c=s.endsWith(`
`)?"":`
`;await p.promises.writeFile(o,s+c+e+`
`,"utf-8"),a.info(`Added ${e} to .gitignore`)}}}var P=f(require("vscode"));function R(t){let e=P.window.activeTerminal;if(!e){P.window.showErrorMessage("Terminal Image Paste: No active terminal. Please open a terminal first.");return}let r="'"+t.replace(/'/g,"'\\''")+"'",s=P.workspace.getConfiguration("terminalImgPaste").get("sendNewline",!1);e.sendText(r,s),a.info(`Inserted path into terminal: ${r}`)}var T=class{_queue=[];_locked=!1;acquire(){return new Promise(e=>{let r=()=>{this._locked?this._queue.push(r):(this._locked=!0,e(()=>{this._locked=!1;let o=this._queue.shift();o&&o()}))};r()})}};function U(t,e){let r=e instanceof Error?e.message:String(e);d.window.showErrorMessage(`Terminal Image Paste: ${r}`),a.error(`${t} command failed`,e)}function me(t){let e=W(),r=L(e),o=G();r.isToolAvailable().then(n=>{n||d.window.showWarningMessage(`Terminal Image Paste: clipboard tool "${r.requiredTool()}" not found. Install it to use clipboard image pasting.`)}).catch(n=>{a.error("Failed to check tool availability",n)});let s=new T,i=d.commands.registerCommand("terminalImgPaste.pasteImage",async()=>{let n=await s.acquire();try{if(!await r.isToolAvailable()){d.window.showWarningMessage(`Terminal Image Paste: "${r.requiredTool()}" is not installed. Please install it to paste clipboard images.`);return}if(!await r.hasImage()){d.window.showInformationMessage("No image found in clipboard.");return}let Y=await r.readImage(),j=await o.save(Y);R(j),d.window.setStatusBarMessage("Image pasted to terminal",3e3)}catch(m){U("pasteImage",m)}finally{n()}}),c=d.commands.registerCommand("terminalImgPaste.sendPathToTerminal",async n=>{try{if(!n?.fsPath){d.window.showErrorMessage("Terminal Image Paste: No file selected.");return}R(n.fsPath),d.window.setStatusBarMessage("Path sent to terminal",3e3)}catch(m){U("sendPathToTerminal",m)}});t.subscriptions.push(i,c),a.info(`Extension activated (platform: ${e.os}, WSL: ${e.isWSL})`)}function de(){a.info("Extension deactivating")}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
